{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"source/images/avatar.jpeg","path":"images/avatar.jpeg","modified":1,"renderable":0},{"_id":"source/images/logo.png","path":"images/logo.png","modified":1,"renderable":0},{"_id":"source/images/Common/android-chrome-192x192.png","path":"images/Common/android-chrome-192x192.png","modified":1,"renderable":0},{"_id":"source/images/Common/android-chrome-512x512.png","path":"images/Common/android-chrome-512x512.png","modified":1,"renderable":0},{"_id":"source/images/Common/apple-touch-icon.png","path":"images/Common/apple-touch-icon.png","modified":1,"renderable":0},{"_id":"source/images/Common/favicon-16x16.png","path":"images/Common/favicon-16x16.png","modified":1,"renderable":0},{"_id":"source/images/Common/favicon-32x32.png","path":"images/Common/favicon-32x32.png","modified":1,"renderable":0},{"_id":"source/images/Common/safari-pinned-tab.svg","path":"images/Common/safari-pinned-tab.svg","modified":1,"renderable":0},{"_id":"themes/stun/source/js/header.js","path":"js/header.js","modified":1,"renderable":1},{"_id":"themes/stun/source/js/scroll.js","path":"js/scroll.js","modified":1,"renderable":1},{"_id":"themes/stun/source/js/sidebar.js","path":"js/sidebar.js","modified":1,"renderable":1},{"_id":"themes/stun/source/js/stun-boot.js","path":"js/stun-boot.js","modified":1,"renderable":1},{"_id":"themes/stun/source/js/utils.js","path":"js/utils.js","modified":1,"renderable":1},{"_id":"themes/stun/source/images/algolia.svg","path":"images/algolia.svg","modified":1,"renderable":1},{"_id":"themes/stun/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":1,"renderable":1},{"_id":"themes/stun/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":1,"renderable":1},{"_id":"themes/stun/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":1,"renderable":1},{"_id":"themes/stun/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":1,"renderable":1},{"_id":"themes/stun/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":1,"renderable":1},{"_id":"themes/stun/source/images/cc-by.svg","path":"images/cc-by.svg","modified":1,"renderable":1},{"_id":"themes/stun/source/images/loading.svg","path":"images/loading.svg","modified":1,"renderable":1},{"_id":"themes/stun/source/css/index.styl","path":"css/index.styl","modified":1,"renderable":1},{"_id":"themes/stun/source/images/icons/favicon-16x16.png","path":"images/icons/favicon-16x16.png","modified":1,"renderable":1},{"_id":"themes/stun/source/images/icons/favicon-32x32.png","path":"images/icons/favicon-32x32.png","modified":1,"renderable":1},{"_id":"themes/stun/source/images/icons/stun-logo.svg","path":"images/icons/stun-logo.svg","modified":1,"renderable":1}],"Cache":[{"_id":"source/categories/index.md","hash":"a5983c49174d91e4836ddf9d857475e2147b2345","modified":1635993929054},{"_id":"source/_posts/2021-09-29-NSTimer 循环引用分析与解决.md","hash":"06972a6085522c782f8be9b591030662257535c2","modified":1632981868614},{"_id":"source/_posts/2021-11-03-iOS编译过程.md","hash":"619c7fcb8fd0f3660bbe09c3ed3dfdf75b9af4d6","modified":1636007574165},{"_id":"source/tags/index.md","hash":"dd6913d248820047ffced5b07ea79af0ab59f7c2","modified":1635993966706},{"_id":"source/.DS_Store","hash":"6df395b19e8da87cef39c5095989d43f5b281355","modified":1636006541654},{"_id":"source/_posts/.DS_Store","hash":"1ae6ee2b130110b301978ff75398d3b160276c78","modified":1636009974492},{"_id":"source/tags/.DS_Store","hash":"34fe290bc8d934cf4c51deea76c7ec16f3cf4d2f","modified":1635993979770},{"_id":"source/images/.DS_Store","hash":"ebef34085880350ef1e9f36a899b852a113de135","modified":1636005985707},{"_id":"source/images/Common/favicon-16x16.png","hash":"a08b6dcee35a779728fd8913a4760ddefb349351","modified":1635997269000},{"_id":"source/images/avatar.jpeg","hash":"18b2e6c338238f0f5182b5e17f04917f766dbb07","modified":1635994494511},{"_id":"source/images/Common/android-chrome-192x192.png","hash":"3476e26eace27a2527d8b0b29b354414a5b97da1","modified":1635997268000},{"_id":"source/images/Common/favicon-32x32.png","hash":"a4e7bb814ec13c73b94a46b76bf48502d2f5c0bd","modified":1635997269000},{"_id":"source/images/Common/safari-pinned-tab.svg","hash":"e8e13aeb58933f948310ea05b6bec212f8eea416","modified":1635997270000},{"_id":"source/images/Common/.DS_Store","hash":"8627dfe4667b87a9ef714f5d40de458acd28f295","modified":1636006541652},{"_id":"source/images/Common/apple-touch-icon.png","hash":"ad6ba7b0df1de25d56361db8e681989f3ad896ea","modified":1635997269000},{"_id":"source/images/logo.png","hash":"e3d0494e7d14edf0fcd8087bb5aa4bfa919d72b2","modified":1635994494519},{"_id":"source/images/Common/android-chrome-512x512.png","hash":"de244e4eae54cc80fbb05e552ad41c4f2178fd80","modified":1635997269000},{"_id":"themes/stun/_config.yml","hash":"3edc10a7954c55cc5a8e8ff838d14b28a4744ab4","modified":1636006261946},{"_id":"themes/stun/package.json","hash":"3a8970ff8499ddd68a3d23ce16c0eb73074a2ccd","modified":1635993607776},{"_id":"themes/stun/languages/zh-CN.yml","hash":"8535e2d34d24769067ba7bd3d9c0b94d1fd01cc7","modified":1635993607765},{"_id":"themes/stun/languages/es.yml","hash":"e150c8a1f56ae9ed065611951aa124fb548577fc","modified":1635993607765},{"_id":"themes/stun/languages/en.yml","hash":"e1348852aa00d2d57f5215c83709f6428f8e8a71","modified":1635993607764},{"_id":"themes/stun/languages/zh-HK.yml","hash":"aef25f329cc05dbe8e38753fccd98d63c9fcd174","modified":1635993607765},{"_id":"themes/stun/layout/_layout.pug","hash":"5052ee5040ae736d78ad208df7352be69b61b0d1","modified":1635993607765},{"_id":"themes/stun/layout/archive.pug","hash":"d45d078ae4196add83e21fcaed3ef168b237af90","modified":1635993607775},{"_id":"themes/stun/layout/index.pug","hash":"df40cf1f051fd29f0f51ace74e9f7394f6ea2ab7","modified":1635993607775},{"_id":"themes/stun/.DS_Store","hash":"a5db2e7fe60b7ff0a0178774a620ca5c7d83c4af","modified":1636010781934},{"_id":"themes/stun/layout/category.pug","hash":"24153408b2971542d177227f09e93da7754bf75e","modified":1635993607775},{"_id":"themes/stun/layout/.DS_Store","hash":"3533d7af440fbce33e5adfac83d868938b9e727a","modified":1635997325129},{"_id":"themes/stun/layout/page.pug","hash":"22ba5928bd9ae8c56b3242b7caa5fc3ec471b082","modified":1635993607775},{"_id":"themes/stun/layout/tag.pug","hash":"46f956ad7e2aed879999ddf5e768d80c4bbe5b5f","modified":1635993607775},{"_id":"themes/stun/scripts/engine.js","hash":"a63a57c9206a77a79f93dbd86e86204447d7d904","modified":1635993607776},{"_id":"themes/stun/layout/post.pug","hash":"a4d16dbb919df5d4ffdb5a1d0114a4e1c8c21197","modified":1635993607775},{"_id":"themes/stun/scripts/merge-config.js","hash":"bb914100129c5ca2d1a9e087fffd7bedcb6ae6a6","modified":1635993607777},{"_id":"themes/stun/layout/_mixins/gallery.pug","hash":"3054e2c09bc205173c517fb1c36321f7c4c0db63","modified":1635993607766},{"_id":"themes/stun/layout/_partials/config.pug","hash":"4fb832652485161148ea957067c06d50ed11578b","modified":1635993607767},{"_id":"themes/stun/layout/_mixins/meta-item.pug","hash":"3d74dc8ba8651efd4a605e56a21e314678d04057","modified":1635993607766},{"_id":"themes/stun/layout/_mixins/menu-item.pug","hash":"93c4454e48a6f1456c29aeb9d1332be186b49d4f","modified":1635993607766},{"_id":"themes/stun/layout/_mixins/post-header.pug","hash":"9486d07e56acf7bcc5d691bef93c19e2e5c98022","modified":1635993607766},{"_id":"themes/stun/layout/_mixins/timeline.pug","hash":"4e19a670f002d3c6bc740a2d6ef03964e6b59c09","modified":1635993607766},{"_id":"themes/stun/layout/_partials/.DS_Store","hash":"feb40b07220e1cc93490603d807864ed57a105ca","modified":1635997325128},{"_id":"themes/stun/source/.DS_Store","hash":"71f744a9ac28dff4194ff882f515caad2a6d944f","modified":1636005951924},{"_id":"themes/stun/layout/_scripts/stun.pug","hash":"961554914427578b57ea3912d751d398f4eb381d","modified":1635993607770},{"_id":"themes/stun/layout/_scripts/vendors.pug","hash":"62a6831d3b1d90d6c8335ce3402efc50e141eafb","modified":1635993607771},{"_id":"themes/stun/layout/_third-party/pjax.pug","hash":"4a786459a8e6a4f378a9d834502f8b11aa66f185","modified":1635993607773},{"_id":"themes/stun/layout/_third-party/quicklink.pug","hash":"2bed65ed4d314dc587e2359e20ae099b46181ed5","modified":1635993607774},{"_id":"themes/stun/source/js/header.js","hash":"63d407ee6f80114e220171ba829b79b28d420fe0","modified":1635993607792},{"_id":"themes/stun/source/js/scroll.js","hash":"8926ab87181a49c730ce5132518b608c54b8cdb1","modified":1635993607792},{"_id":"themes/stun/source/js/sidebar.js","hash":"20adff7f54bcd8299d32690d41ebc7a4eb7a8728","modified":1635993607792},{"_id":"themes/stun/source/images/cc-by-nc-nd.svg","hash":"017ad912874686a982ebceae359299b8f2a492e2","modified":1635993607790},{"_id":"themes/stun/source/js/stun-boot.js","hash":"8358ac0d879c0ca340c52e4de606523c2a91e156","modified":1635993607792},{"_id":"themes/stun/source/images/algolia.svg","hash":"90322f80db6ad0daf26ea3ec71dea6f691a8b2f1","modified":1635993607790},{"_id":"themes/stun/source/images/cc-by-nc.svg","hash":"4608189edbe7636dd651df65473298a3c5afb20d","modified":1635993607790},{"_id":"themes/stun/source/images/cc-by-nc-sa.svg","hash":"71d035c34219f924dbf1bf852166ee8fb58d2f24","modified":1635993607790},{"_id":"themes/stun/source/js/utils.js","hash":"b570eafe77e47d7701348f172a4dbaaba6fa8123","modified":1635993607793},{"_id":"themes/stun/source/images/cc-by-sa.svg","hash":"0455a8857ba096925d4145a56e8d10537fccb378","modified":1635993607791},{"_id":"themes/stun/source/images/cc-by-nd.svg","hash":"20c66ae3c393903e6eab3bc8cf7c3be6d753f9f8","modified":1635993607790},{"_id":"themes/stun/source/css/index.styl","hash":"8a75ec81fb064b0da2f978a064cc5bec2395f27d","modified":1635993607789},{"_id":"themes/stun/source/images/cc-by.svg","hash":"77f74c241902447424207869c74cb9d9264bdced","modified":1635993607791},{"_id":"themes/stun/source/images/loading.svg","hash":"32a6e770d217ae6c0cf0f6beef3172f1b5b9a0a2","modified":1635993607791},{"_id":"themes/stun/scripts/filters/external-link.js","hash":"f5369becfd8cc6e43d6dc3595b1edbe014d9aa7c","modified":1635993607776},{"_id":"themes/stun/scripts/filters/wrap-table.js","hash":"888c9eaaddcdb9b88d07837a9091aa39ed3fe677","modified":1635993607777},{"_id":"themes/stun/scripts/filters/image-setting.js","hash":"412318b6d189d5355dbcc52c9762072f7ecdaad4","modified":1635993607776},{"_id":"themes/stun/scripts/filters/lazyload.js","hash":"d5baf39faeff5368182be1f59fb598d023985cde","modified":1635993607776},{"_id":"themes/stun/scripts/filters/post-heading.js","hash":"b504aa047e3f080fc3f95f3e96fad88bbbce20cb","modified":1635993607777},{"_id":"themes/stun/scripts/filters/shake-file.js","hash":"159dff6e4f7020545c9b151108398cd383d613e2","modified":1635993607777},{"_id":"themes/stun/scripts/tags/friends.js","hash":"c2fe1e8e128f464d772bcb7534efef54ad224310","modified":1635993607777},{"_id":"themes/stun/scripts/tags/note.js","hash":"b436593a56e3bab8dd59c71e73ac9efbc8fa29d4","modified":1635993607778},{"_id":"themes/stun/scripts/tags/table.js","hash":"177061e1bfb296981a101643f51a27ccc1469307","modified":1635993607778},{"_id":"themes/stun/layout/_partials/footer/footer.pug","hash":"e3d5e4d6ebec59a2511d03fa2b143fd24ae83507","modified":1636006523543},{"_id":"themes/stun/layout/_partials/analytics/busuanzi.pug","hash":"80d2f4f8706a96b367ac1e89f5b56ada4684d571","modified":1635993607767},{"_id":"themes/stun/layout/_partials/header/header.pug","hash":"7ecbe18da15d3a52c56f69c542540291b6178763","modified":1635993607768},{"_id":"themes/stun/layout/_partials/head/head.pug","hash":"c7909a6a50c7a76a6c1810b700a5d72bcb1e20c9","modified":1635993607767},{"_id":"themes/stun/layout/_partials/head/kill-old-ie.pug","hash":"427a95d02844f29e63c5e9f014ede3609aec1a5b","modified":1635993607767},{"_id":"themes/stun/layout/_partials/post/post-list.pug","hash":"c049078009aa251fc76cd948837c7a5efdd39cb2","modified":1635993607768},{"_id":"themes/stun/layout/_partials/search/algolia.pug","hash":"61181bece0e27929fe00df5204fefd8dee31a354","modified":1635993607768},{"_id":"themes/stun/layout/_partials/search/localsearch.pug","hash":"4d8e0bc33f92a603e0b2a5f4296af6bcc7cc31b8","modified":1635993607769},{"_id":"themes/stun/layout/_partials/search/index.pug","hash":"0f84aa013a96e7eb3bb25b87f20bab9b7ac55538","modified":1635993607769},{"_id":"themes/stun/layout/_partials/sidebar/sidebar.pug","hash":"18173a2acf99db39748c392f2e669acd805b4090","modified":1635993607769},{"_id":"themes/stun/layout/_partials/search/assist-btns.pug","hash":"7e6dc0d975ccbe291116487b15277d27a391fb9a","modified":1635993607768},{"_id":"themes/stun/layout/_partials/widgets/comments.pug","hash":"af1b16be74c7e1242e0f57986672dc73e93546e2","modified":1635993607769},{"_id":"themes/stun/layout/_partials/widgets/copyright.pug","hash":"0938c885697f6eb388b28ddbf88f5631d024fe73","modified":1635993607769},{"_id":"themes/stun/layout/_partials/widgets/back2top.pug","hash":"48b7fedeb472bd01fd1f3317359a10e83ca919e1","modified":1635993607769},{"_id":"themes/stun/layout/_partials/widgets/loading-bar.pug","hash":"6cda7866f9589c9ffc05ce4a3d7c33b706e70324","modified":1635993607770},{"_id":"themes/stun/layout/_partials/widgets/reward.pug","hash":"c9081c1dcf0ca18df06d23638654d8f43b28d55c","modified":1635993607770},{"_id":"themes/stun/layout/_partials/widgets/night-mode.pug","hash":"c7f9bd67cd231b9bd40a84123644e009ac8d8ef3","modified":1635993607770},{"_id":"themes/stun/layout/_partials/widgets/paginator.pug","hash":"b0045dcb9b151ee31f1db5b7d741f10ef3b74be0","modified":1635993607770},{"_id":"themes/stun/layout/_third-party/advertising/google-adsense.pug","hash":"e489020f1130976d3ec2245915ede6319d89b89c","modified":1635993607771},{"_id":"themes/stun/layout/_partials/widgets/sticky-top.pug","hash":"bf86b2f9f4b1471afb8b31965d3230f6088682ae","modified":1635993607770},{"_id":"themes/stun/layout/_partials/widgets/share.pug","hash":"1bb3d25298b7ee6a28150aa286ed6b0ae42ead4f","modified":1635993607770},{"_id":"themes/stun/layout/_third-party/advertising/index.pug","hash":"1285cd65a873f688ae3c51846c1284447f502adc","modified":1635993607771},{"_id":"themes/stun/layout/_third-party/analytics/baidu-analytics.pug","hash":"f7300991a29dbe2e8091a588dfa8c65c3dee6302","modified":1635993607771},{"_id":"themes/stun/layout/_third-party/analytics/busuanzi.pug","hash":"78a4fc9c9380e31536f5b500638f2d005accd361","modified":1635993607771},{"_id":"themes/stun/layout/_third-party/analytics/google-analytics.pug","hash":"4eef66fbb8a8ad55e0868cf4b77a6b7bca0e7f35","modified":1635993607771},{"_id":"themes/stun/layout/_third-party/analytics/index.pug","hash":"0d72f844bf9532b3be644c27b0af7cb4331fc46c","modified":1635993607771},{"_id":"themes/stun/layout/_third-party/analytics/tencent-analytics.pug","hash":"f88fb0f085812db6023c30308ba3458da7742993","modified":1635993607772},{"_id":"themes/stun/layout/_third-party/comments/disqus.pug","hash":"57bcbaac3d237d9168dd8f4b682f34351f11d250","modified":1635993607772},{"_id":"themes/stun/layout/_third-party/comments/gitalk.pug","hash":"c2a90e80c51b5b99e6804dbed5457a071b980bbd","modified":1635993607772},{"_id":"themes/stun/layout/_third-party/comments/index.pug","hash":"bec4d9c8ea360637e7da3314fa987e33facd8071","modified":1635993607772},{"_id":"themes/stun/layout/_third-party/comments/minivaline.pug","hash":"5584ade7dd19deca418373115bde9d563d37d826","modified":1635993607772},{"_id":"themes/stun/layout/_third-party/comments/fbcomments.pug","hash":"fb651812c87dc5e2134d7fb7d8f98d4d4227f1f6","modified":1635993607772},{"_id":"themes/stun/layout/_third-party/comments/utterances.pug","hash":"6418baeb3aedcddb02a64bd89b26ac12e18551c8","modified":1635993607773},{"_id":"themes/stun/layout/_third-party/comments/valine.pug","hash":"b519a6948d6ef37c037385e3e3f9590c17f7ad62","modified":1635993607773},{"_id":"themes/stun/layout/_third-party/comments/livere.pug","hash":"687f74a998519608944b40a41f3a98ccf4535139","modified":1635993607772},{"_id":"themes/stun/layout/_third-party/comments/waline.pug","hash":"fd4c958b13777752f176556c7b109b7dede7cc68","modified":1635993607773},{"_id":"themes/stun/layout/_third-party/math/index.pug","hash":"e952be6c736545e73c0e02f833f87a4f8c5a2582","modified":1635993607773},{"_id":"themes/stun/layout/_third-party/math/katex.pug","hash":"345c59fe76a7c83b529328e5144d1036cb14f533","modified":1635993607773},{"_id":"themes/stun/layout/_third-party/math/mathjax.pug","hash":"72d51538cc85f01c8c64db74b9219ccaf334c9e9","modified":1635993607773},{"_id":"themes/stun/layout/_third-party/search/algolia.pug","hash":"54233748e22ceae063f70ee49b44c4bd0a78f391","modified":1635993607774},{"_id":"themes/stun/layout/_third-party/search/localsearch.pug","hash":"d98db7ed7e3e4c574212fa9d75adba681f3d0687","modified":1635993607774},{"_id":"themes/stun/layout/_third-party/search/index.pug","hash":"0f84aa013a96e7eb3bb25b87f20bab9b7ac55538","modified":1635993607774},{"_id":"themes/stun/source/images/icons/favicon-16x16.png","hash":"7bfd64eac26e17ea162f0c399a4a40164c26b412","modified":1635993607791},{"_id":"themes/stun/source/images/icons/stun-logo.svg","hash":"069dc7590ad152373f1c346d892e32faa2bbdd87","modified":1635993607791},{"_id":"themes/stun/source/css/_common/index.styl","hash":"86057db6cb18263866d62a6669feee8752882398","modified":1635993607787},{"_id":"themes/stun/source/css/_common/responsive.styl","hash":"618c6005f1bc7c482fa37ae3ce15729a64044d9d","modified":1635993607788},{"_id":"themes/stun/source/css/_custom/index.styl","hash":"0d1adc70250941074c742f94f7801b3b43a7f1db","modified":1635993607789},{"_id":"themes/stun/source/images/icons/favicon-32x32.png","hash":"02fead07726920400ede57ddfdbf071dd7203fd5","modified":1635993607791},{"_id":"themes/stun/source/css/_variables/index.styl","hash":"c81aac4285eb058026b255e31282d35f55a820ab","modified":1635993607789},{"_id":"themes/stun/source/css/_mixins/index.styl","hash":"f3060519f3acd05cb4b26bb5f6a5c6b857cb0d68","modified":1635993607789},{"_id":"themes/stun/source/css/_common/components/index.styl","hash":"a54720db94121efd1a34ac88d344197c8206837e","modified":1635993607780},{"_id":"themes/stun/source/css/_common/outline/macro.styl","hash":"13b96f239de15e1cfdc14d9c80e6959506556dd2","modified":1635993607787},{"_id":"themes/stun/source/css/_common/outline/index.styl","hash":"467d4171c0690a95d40fbecea02e6b212b7c74f1","modified":1635993607787},{"_id":"themes/stun/source/css/_common/scaffolding/base.styl","hash":"4064a7e2c3f71d2ed72a47edd60e9be01af6c354","modified":1635993607788},{"_id":"themes/stun/source/css/_common/scaffolding/normalize.styl","hash":"c15a9616fddb267431416304d709185aeb3d45f5","modified":1635993607788},{"_id":"themes/stun/source/css/_common/scaffolding/index.styl","hash":"e750f2dae9eb3385039ee018ff8001b0e6ec3b64","modified":1635993607788},{"_id":"themes/stun/source/css/_common/scaffolding/utils.styl","hash":"7e62f34521ea539a25a101f25e1684e3a3ac4be8","modified":1635993607788},{"_id":"themes/stun/source/css/_common/components/analytics/index.styl","hash":"339a43fd5ee97a77775b723118f6ab1af754fed4","modified":1635993607778},{"_id":"themes/stun/source/css/_common/components/analytics/busuanzi.styl","hash":"d196c88ea2e9b851e8d8f9c5a315dfc2929eb897","modified":1635993607778},{"_id":"themes/stun/source/css/_common/components/footer/index.styl","hash":"14464841145cf3ecab66f1094653daa033c261eb","modified":1635993607779},{"_id":"themes/stun/source/css/_common/components/highlight/diff.styl","hash":"056e70f6dfe45ec50427d7ab293d33361c9b956f","modified":1635993607779},{"_id":"themes/stun/source/css/_common/components/header/index.styl","hash":"904af0e73cdf0767ec781271856d7b5b63e043ef","modified":1635993607779},{"_id":"themes/stun/source/css/_common/components/pages/index.styl","hash":"463a4e6a92ec5f757e167fbeb171e4e92e83a822","modified":1635993607780},{"_id":"themes/stun/source/css/_common/components/highlight/highlight.styl","hash":"bc0b01021a0d19b2c98f0c5c9fa1af96d67c1099","modified":1635993607779},{"_id":"themes/stun/source/css/_common/components/highlight/index.styl","hash":"85848179cbc78152d2521b601ac9f888dea4e255","modified":1635993607779},{"_id":"themes/stun/source/css/_common/components/pages/timeline.styl","hash":"21e9c8def1613030f0927e2ce80f4ecc721f078e","modified":1635993607780},{"_id":"themes/stun/source/css/_common/components/highlight/theme.styl","hash":"dfc99b05302f8203040431e563c9f63d63da46de","modified":1635993607780},{"_id":"themes/stun/source/css/_common/components/pages/page.styl","hash":"df732e267dfd9f1bda6a8cf1ede3198a205925f9","modified":1635993607780},{"_id":"themes/stun/source/css/_common/components/post/index.styl","hash":"08aad11e329cda0550efef226e0c4d0bb4540454","modified":1635993607781},{"_id":"themes/stun/source/css/_common/components/post/post.styl","hash":"8b7b22225b40d028efee689d3700a9796291cb8d","modified":1635993607782},{"_id":"themes/stun/source/css/_common/components/search/algolia.styl","hash":"fb62e4baf25a66e46c27783be5d79353ec394b44","modified":1635993607782},{"_id":"themes/stun/source/css/_common/components/post/post-list.styl","hash":"d0ed844e28533f832cbd9b3f09203d16936628f7","modified":1635993607782},{"_id":"themes/stun/source/css/_common/components/search/common.styl","hash":"1939b7dfbcf557794a188fbf8fec4ef2b5afa437","modified":1635993607782},{"_id":"themes/stun/source/css/_common/components/search/index.styl","hash":"1990d2c2a9bfe8e09d656f0c2ae6cf0c9f7f5542","modified":1635993607782},{"_id":"themes/stun/source/css/_common/components/search/localsearch.styl","hash":"bf1ac1b8ee8c4daaa7e6b47eec097a176624e6d0","modified":1635993607783},{"_id":"themes/stun/source/css/_common/components/plugins/friends.styl","hash":"bdb015173f8e5fa391fc4fb2b2a8d42787022c4b","modified":1635993607781},{"_id":"themes/stun/source/css/_common/components/sidebar/index.styl","hash":"02138647437f7e8ee8927cae225d41072d936bdc","modified":1635993607783},{"_id":"themes/stun/source/css/_common/components/plugins/index.styl","hash":"c35d0cf421c6669ee0458c2f0264dca05769c01d","modified":1635993607781},{"_id":"themes/stun/source/css/_common/components/plugins/note.styl","hash":"ae0ad9b44a87839d220792336478a9ae6db11c47","modified":1635993607781},{"_id":"themes/stun/source/css/_common/components/widgets/comments.styl","hash":"41d229ac4fa02a3a8b46687ccbafa7a608008e2f","modified":1635993607784},{"_id":"themes/stun/source/css/_common/components/plugins/table.styl","hash":"98cacc91e42f5e45279e2174a90ab26171085e2f","modified":1635993607781},{"_id":"themes/stun/source/css/_common/components/widgets/copy-button.styl","hash":"378961fa7c986e3313053814806902bf76204a93","modified":1635993607784},{"_id":"themes/stun/source/css/_common/components/widgets/back2top.styl","hash":"b3da5ea71a9947e781056d1bd7d42e4045fa2aca","modified":1635993607783},{"_id":"themes/stun/source/css/_common/components/widgets/ending.styl","hash":"63985ca9a3f6c481cc60207966fa1267de14d945","modified":1635993607784},{"_id":"themes/stun/source/css/_common/components/widgets/fancybox.styl","hash":"3d677c0323d77199bb9fbfefd65e97d8b882d7b3","modified":1635993607784},{"_id":"themes/stun/source/css/_common/components/widgets/copyright.styl","hash":"1d28fc8f76f7164a306ed81a9ede21c0a2b0f7cd","modified":1635993607784},{"_id":"themes/stun/source/css/_common/components/widgets/font-icon.styl","hash":"bdda0953611378e93a8d6387cbdc93e1de4f7f0a","modified":1635993607785},{"_id":"themes/stun/source/css/_common/components/widgets/gallery-image.styl","hash":"99b1cc42f38816083f93233778b299422b6d8f32","modified":1635993607785},{"_id":"themes/stun/source/css/_common/components/widgets/index.styl","hash":"03ffdc55fd5fb64c3158bc222d0e8e9d7844686b","modified":1635993607785},{"_id":"themes/stun/source/css/_common/components/widgets/lazyload.styl","hash":"eced96235f0ff5dc6a8fd068d4ed05934a29b430","modified":1635993607785},{"_id":"themes/stun/source/css/_common/components/widgets/loading-bar.styl","hash":"9f23e8762d01fb4a3cbf5e786fdead2926849e8a","modified":1635993607786},{"_id":"themes/stun/source/css/_common/components/widgets/night-mode.styl","hash":"9caeef13a913aba38976f082e1f0ca191bffc64e","modified":1635993607786},{"_id":"themes/stun/source/css/_common/components/widgets/reward.styl","hash":"de1130ec3765879884cbdc77a15b458da6e37bcc","modified":1635993607786},{"_id":"themes/stun/source/css/_common/components/widgets/paginator.styl","hash":"71ddb6a1e9664a4fde04a0ce143b8786ba6e0089","modified":1635993607786},{"_id":"themes/stun/source/css/_common/components/widgets/share.styl","hash":"fe32e3434107d92cefd7aacfdcef526a93c4b865","modified":1635993607786},{"_id":"themes/stun/source/css/_common/components/widgets/sticky-top.styl","hash":"f0e37944168a74a64b18dc54c6fde2308e4bf023","modified":1635993607786},{"_id":"themes/stun/source/css/_common/components/widgets/zoom-image.styl","hash":"40f832a199320642debabe32910c1168e3c6e40c","modified":1635993607787}],"Category":[{"name":"iOS","_id":"ckvko2j2d0003qezueplv40vs"}],"Data":[],"Page":[{"title":"tags","date":"2021-11-04T02:44:32.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2021-11-04 10:44:32\ntype: \"tags\"\n---\n","updated":"2021-11-04T02:46:06.706Z","path":"tags/index.html","comments":1,"layout":"page","_id":"ckvko2j260000qezu0z2r2q0n","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"categories","date":"2021-11-04T02:44:20.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2021-11-04 10:44:20\ntype: \"categories\"\n---\n","updated":"2021-11-04T02:45:29.054Z","path":"categories/index.html","comments":1,"layout":"page","_id":"ckvko2j2b0002qezua42ggvjf","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"iOS 编译过程","_content":"\n# iOS 编译过程 \n\n## 1. 前言\n\n学习 **iOS** 编译过程（**Compile**）有助于我们更好理解代码是如何被计算机运作起来，编译器为代码做了哪些优化，让我们学会从另一个角度来看待问题。\n\n## 2. 编译器结构\n\n现代编译器是将源代码转换成可执行文件的程序，工作流程主要分为 **前端** 和 **后端** 两个部分：\n\n1. 前端：对源代码进行解析，并生成中间代码。\n2. 后端：针对中间代码进行优化，并转换成目标机器的代码指令。\n\n```mermaid\ngraph LR\n\tA(SourceCode) --> B(Frontend)\n    B(Frontend) --> C(Backend)\n    C(Backend) --> D(Machine Code)\n```\n\n针对iOS平台，不同语言采用了不同的编译器前端：\n\n1. **Frontend：Clang / SwiftC**\n\n   对于 **Objective-C / C / C++ / Objective-C++**  来说采用 **Clang** 编译器前端；\n\n   对于 **Swift** 来说则采用 **SwiftC**；\n\n2. **Backend：LLVM**\n\n   无论是 **C** 系语言还是 **Swift** 都采用 **LLVM** 作为编译器后端；\n\n值得注意的是在 **Xcode3** 以前，都采用 **GCC** 作为编译器前端，但为 **Apple** 快速发展需要功能更强大和性能更好的编译器，所以 **Apple** 自己开发了 **Clang** 作为编译器前端。下面对编译器做一个简要介绍：\n\n* **GCC**\n\n**GCC**（**GNU Compile Collection**，**GNU **编译器套装），是一套由 **GNU** 开发的编程语言编译器。来本只能处理 *C* 语言，后来快速演进，变得可处理 **C++、Objective-C、Java、Fortran** 等其他语言。但由于一些缺陷，导致了 **Apple** 抛弃了 **GCC** ，开发出了 **Clang** 作为其前端编译器。\n\n1. **GCC** 的 **Objective-C Frontend** 不是 **Apple** 维护，导致想要添加一些语法提示等功能得去要求 **GCC** 团队做。\n2. **GCC** 的插件、工具、**IDE** 的支持薄弱。\n3. **GCC** 的编译效率和性能不足。\n\n* **Clang**\n\n**Clang1.0** 于 **2009** 年正式与 **LLVM2.6** 正式发布，旨在提供 **GCC** 的替代品，支持了 **GUN** 编译器大多数的编译器设置以及非官方语言的拓展，相较于 **GCC** ，**Clang** 具有以下优势：\n\n1. 编译速度更快。\n2. 占用内存更小。\n3. 模块化设计，易于拓展与重用。\n4. 诊断信息可读性强。\n\n* **SwiftC**\n\n**SwiftC** 在前端采用了 **SIL** 中间语言，这是因为 **Swift** 作为一种高级语言，有许多特性，如 **protocol** 的泛型，也是一门安全的语言，确保变量在使用之前被初始化、检测不可执行的代码，于是增加了一层 **SIL** 来做这些事情。\n\n* **LLVM**\n\n**LLVM** 是一套编译器基础设备项目，由 **C++** 写成，包含一系列模块化的编译器组件和工具链，用来开发编译器的前端和后端。在 **iOS** 中，**LLVM** 作为编译器后端主要提供 **Optimizer** 和 **Code Generator** ，将接收到的 **IR** 中间代码进行优化，以及机器代码生成。\n\n## 3. 编译过程\n\n### 3.1 流程梳理\n\n```mermaid\ngraph TD\n    subgraph Clang\n\tid1(源代码) --> id2(预处理) \n    id2(预处理) --> id3(语法分析)   \n    id3(语法分析) --  token  --> id4(语法分析)\n    id4(语法分析) --  AST  --> id5(中间代码生成)\n    end\n    \n    subgraph Optimizer, Backend\n    id6(中间代码优化) --> id7(BitCode生成)\n    id7(BitCode生成) --> id8(汇编指令生成)\n    id8(汇编指令生成) --> id9(机器码生成)\n    id9(机器码生成) --> id11(链接生成可执行文件)\n    end\n    \n    subgraph SwiftC\n    id12(源代码) --> id13(解析)\n    id13(解析) --> id14(语义分析)\n    id14(语义分析) --> id15(Clang导入器)\n    id15(Clang导入器) --> id16(SIL生成)\n    id16(SIL生成) --> id17(SIL保证转换)\n    id17 --> id18(SIL优化)\n    id18(SIL优化) --> id19(中间代码生成)\n    end\n    \n    id5 --  IR  --> id6\n    id19 --  IR  --> id6\n```\n\n在前端 **Objective-C** 和 **Swift** 分别由自己的处理阶段，但最后都会生成 **IR** 中间代码，交由后端进行统一处理。\n\n下面我们从一个简单的.m文件进行编译过程梳理，首先在某一个目录下创建一个 **nihao.m**文件\n\n```shell\ntouch nihao.m\n```\n\n**nihao.m：**\n\n```objective-c\n#import <Foundation/Foundation.h>\nint main(int argc, char *argv[])\n{\n    @autoreleasepool {\n        NSLog(@\"nihao!!!\");\n        return 0;\n    }\n}\n```\n\n### 3.2 Clang阶段（Objective-C / C++ / C / Objective-C++）\n\n#### 预处理阶段：\n\n```shell\nxcrun clang -E helloworld.c | open -f\n```\n\n```\n# 1 \"nihao.m\"\n# 1 \"<built-in>\" 1\n# 1 \"<built-in>\" 3\n# 380 \"<built-in>\" 3\n# 1 \"<command line>\" 1\n# 1 \"<built-in>\" 2\n# 1 \"nihao.m\" 2\n# 1 \"/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/System/Library/Frameworks/Foundation.framework/Headers/Foundation.h\" 1 3\n\n...\n...\n...\n\nint main(int argc, char *argv[])\n{\n    @autoreleasepool {\n        NSLog(@\"nihao!!!\");\n        return 0;\n    }\n}\n```\n\n将预处理阶段输出到文件， 可以看到很多以 **#** 开头的语句，这些语句告诉我们后面跟着的内容来自哪里，这里可以看见 **Foundation.h** 文件的内容也包含了进来。在 **Xcode** 中，也可以通过 **Product ->  Perfrom Action -> Preprocess** 查看预处理阶段之后的代码。在预处理阶段做了以下这些事情：\n\n* 将头文件引入的其他文件加入源文件中，是一个递归的过程。\n* 进行条件编译处理。\n* 将宏定义直接替换，不进行语法检查。\n* 将注释进行删除处理。\n\n#### 词法分析阶段\n\n```shell\nxcrun clang -fmodules -fsyntax-only -Xclang -dump-tokens nihao.m\n```\n\n```\nannot_module_include '#import <Foundation/Foundation.h>\n\n'\t\tLoc=<nihao.m:1:1>\nint 'int'\t [StartOfLine]\tLoc=<nihao.m:3:1>\nidentifier 'main'\t [LeadingSpace]\tLoc=<nihao.m:3:5>\nl_paren '('\t\tLoc=<nihao.m:3:9>\nint 'int'\t\tLoc=<nihao.m:3:10>\nidentifier 'argc'\t [LeadingSpace]\tLoc=<nihao.m:3:14>\ncomma ','\t\tLoc=<nihao.m:3:18>\nchar 'char'\t [LeadingSpace]\tLoc=<nihao.m:3:20>\nstar '*'\t [LeadingSpace]\tLoc=<nihao.m:3:25>\nidentifier 'argv'\t\tLoc=<nihao.m:3:26>\nl_square '['\t\tLoc=<nihao.m:3:30>\nr_square ']'\t\tLoc=<nihao.m:3:31>\nr_paren ')'\t\tLoc=<nihao.m:3:32>\nl_brace '{'\t [StartOfLine]\tLoc=<nihao.m:4:1>\nat '@'\t [StartOfLine] [LeadingSpace]\tLoc=<nihao.m:5:5>\nidentifier 'autoreleasepool'\t\tLoc=<nihao.m:5:6>\n...\n```\n\n词法分析阶段其实是将源代码以字符文本的形式转换成 **Token** 流的形式，不涉及语义校验，用来标识出这个字符是标识符、括号、if语句...，最后还会标识出其所在位置，方便后续分析能够找出出错的原始位置。\n\n#### 语法分析阶段\n\n```\nxcrun clang -fsyntax-only -Xclang -ast-dump nihao.m | open -f\n```\n\n```\n...\n`-FunctionDecl 0x7f9eb4bd61a0 <nihao.m:3:1, line:9:1> line:3:5 main 'int (int, char **)'\n  |-ParmVarDecl 0x7f9eb4bd5fc0 <col:10, col:14> col:14 argc 'int'\n  |-ParmVarDecl 0x7f9eb4bd6080 <col:20, col:31> col:26 argv 'char **':'char **'\n  `-CompoundStmt 0x7f9eb4bd63d0 <line:4:1, line:9:1>\n    `-ObjCAutoreleasePoolStmt 0x7f9eb4bd63b8 <line:5:5, line:8:5>\n      `-CompoundStmt 0x7f9eb4bd6398 <line:5:22, line:8:5>\n        |-CallExpr 0x7f9eb4bd6328 <line:6:9, col:26> 'void'\n        | |-ImplicitCastExpr 0x7f9eb4bd6310 <col:9> 'void (*)(id, ...)' <FunctionToPointerDecay>\n        | | `-DeclRefExpr 0x7f9eb4bd6250 <col:9> 'void (id, ...)' Function 0x7f9eb0c8d6c8 'NSLog' 'void (id, ...)'\n        | `-ImplicitCastExpr 0x7f9eb4bd6350 <col:15, col:16> 'id':'id' <BitCast>\n        |   `-ObjCStringLiteral 0x7f9eb4bd6290 <col:15, col:16> 'NSString *'\n        |     `-StringLiteral 0x7f9eb4bd6270 <col:16> 'char [9]' lvalue \"nihao!!!\"\n        `-ReturnStmt 0x7f9eb4bd6388 <line:7:9, col:16>\n          `-IntegerLiteral 0x7f9eb4bd6368 <col:16> 'int' 0\n```\n\n语法分析阶段会输出 **AST**（抽象语法树），它是源代码语法结构的一种抽象表示。它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。通过它，可以进行语法错误分析，以及静态分析操作，涵盖内存操作和安全等方面。\n\n#### CodeGen阶段\n\n```shell\nxcrun clang -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll\n```\n\n```\n; ModuleID = 'nihao.m'\nsource_filename = \"nihao.m\"\ntarget datalayout = \"e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128\"\ntarget triple = \"x86_64-apple-macosx11.0.0\"\n\n%struct.__NSConstantString_tag = type { i32*, i32, i8*, i64 }\n\n@__CFConstantStringClassReference = external global [0 x i32]\n@.str = private unnamed_addr constant [9 x i8] c\"nihao!!!\\00\", section \"__TEXT,__cstring,cstring_literals\", align 1\n@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag { i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 }, section \"__DATA,__cfstring\", align 8 #0\n\n; Function Attrs: noinline optnone ssp uwtable\ndefine i32 @main(i32 %0, i8** %1) #1 {\n  %3 = alloca i32, align 4\n  %4 = alloca i32, align 4\n  %5 = alloca i8**, align 8\n  store i32 0, i32* %3, align 4\n  store i32 %0, i32* %4, align 4\n  store i8** %1, i8*** %5, align 8\n  %6 = call i8* @llvm.objc.autoreleasePoolPush() #2\n  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*))\n  store i32 0, i32* %3, align 4\n  call void @llvm.objc.autoreleasePoolPop(i8* %6)\n  %7 = load i32, i32* %3, align 4\n  ret i32 %7\n}\n\n; Function Attrs: nounwind\ndeclare i8* @llvm.objc.autoreleasePoolPush() #2\n\ndeclare void @NSLog(i8*, ...) #3\n\n; Function Attrs: nounwind\ndeclare void @llvm.objc.autoreleasePoolPop(i8*) #2\n\nattributes #0 = { \"objc_arc_inert\" }\nattributes #1 = { noinline optnone ssp uwtable \"darwin-stkchk-strong-link\" \"disable-tail-calls\"=\"false\" \"frame-pointer\"=\"all\" \"less-precise-fpmad\"=\"false\" \"min-legal-vector-width\"=\"0\" \"no-infs-fp-math\"=\"false\" \"no-jump-tables\"=\"false\" \"no-nans-fp-math\"=\"false\" \"no-signed-zeros-fp-math\"=\"false\" \"no-trapping-math\"=\"true\" \"probe-stack\"=\"___chkstk_darwin\" \"stack-protector-buffer-size\"=\"8\" \"target-cpu\"=\"penryn\" \"target-features\"=\"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87\" \"tune-cpu\"=\"generic\" \"unsafe-fp-math\"=\"false\" \"use-soft-float\"=\"false\" }\nattributes #2 = { nounwind }\nattributes #3 = { \"darwin-stkchk-strong-link\" \"disable-tail-calls\"=\"false\" \"frame-pointer\"=\"all\" \"less-precise-fpmad\"=\"false\" \"no-infs-fp-math\"=\"false\" \"no-nans-fp-math\"=\"false\" \"no-signed-zeros-fp-math\"=\"false\" \"no-trapping-math\"=\"true\" \"probe-stack\"=\"___chkstk_darwin\" \"stack-protector-buffer-size\"=\"8\" \"target-cpu\"=\"penryn\" \"target-features\"=\"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87\" \"tune-cpu\"=\"generic\" \"unsafe-fp-math\"=\"false\" \"use-soft-float\"=\"false\" }\n\n!llvm.module.flags = !{!0, !1, !2, !3, !4, !5, !6, !7}\n!llvm.ident = !{!8}\n\n!0 = !{i32 2, !\"SDK Version\", [2 x i32] [i32 12, i32 0]}\n!1 = !{i32 1, !\"Objective-C Version\", i32 2}\n!2 = !{i32 1, !\"Objective-C Image Info Version\", i32 0}\n!3 = !{i32 1, !\"Objective-C Image Info Section\", !\"__DATA,__objc_imageinfo,regular,no_dead_strip\"}\n!4 = !{i32 1, !\"Objective-C Garbage Collection\", i8 0}\n!5 = !{i32 1, !\"Objective-C Class Properties\", i32 64}\n!6 = !{i32 1, !\"wchar_size\", i32 4}\n!7 = !{i32 7, !\"PIC Level\", i32 2}\n!8 = !{!\"Apple clang version 13.0.0 (clang-1300.0.29.3)\"}\n```\n\n**CodeGen** 阶段负责将 **AST** 自顶向下遍历逐步翻译成 **LLVM IR**，也就是编译器后端所需要的中间代码，同时 **Objective-C** 代码也会在这一步进行 **Runtime** 桥接： **property** 合成，**ARC** 处理等，如上方可以看见 **autoreleasePoolPush** 、 **autoreleasePoolPop** 操作。\n\n至此 **Clang** 前端工作算是完成，接下来就交给后端进行处理。\n\n### 3.3 LLVM Optimizer 阶段\n\n#### IR代码优化\n\n```shell\nxcrun clang -Os -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll\n```\n\n```\n; ModuleID = 'nihao.m'\nsource_filename = \"nihao.m\"\ntarget datalayout = \"e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128\"\ntarget triple = \"x86_64-apple-macosx11.0.0\"\n\n%struct.__NSConstantString_tag = type { i32*, i32, i8*, i64 }\n\n@__CFConstantStringClassReference = external global [0 x i32]\n@.str = private unnamed_addr constant [9 x i8] c\"nihao!!!\\00\", section \"__TEXT,__cstring,cstring_literals\", align 1\n@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag { i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 }, section \"__DATA,__cfstring\", align 8 #0\n\n; Function Attrs: optsize ssp uwtable\ndefine i32 @main(i32 %0, i8** nocapture readnone %1) local_unnamed_addr #1 {\n  %3 = tail call i8* @llvm.objc.autoreleasePoolPush() #2\n  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*)) #4, !clang.arc.no_objc_arc_exceptions !9\n  tail call void @llvm.objc.autoreleasePoolPop(i8* %3) #2\n  ret i32 0\n}\n\n; Function Attrs: nounwind\ndeclare i8* @llvm.objc.autoreleasePoolPush() #2\n\n; Function Attrs: optsize\ndeclare void @NSLog(i8*, ...) local_unnamed_addr #3\n\n; Function Attrs: nounwind\ndeclare void @llvm.objc.autoreleasePoolPop(i8*) #2\n\nattributes #0 = { \"objc_arc_inert\" }\nattributes #1 = { optsize ssp uwtable \"darwin-stkchk-strong-link\" \"disable-tail-calls\"=\"false\" \"frame-pointer\"=\"all\" \"less-precise-fpmad\"=\"false\" \"min-legal-vector-width\"=\"0\" \"no-infs-fp-math\"=\"false\" \"no-jump-tables\"=\"false\" \"no-nans-fp-math\"=\"false\" \"no-signed-zeros-fp-math\"=\"false\" \"no-trapping-math\"=\"true\" \"probe-stack\"=\"___chkstk_darwin\" \"stack-protector-buffer-size\"=\"8\" \"target-cpu\"=\"penryn\" \"target-features\"=\"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87\" \"tune-cpu\"=\"generic\" \"unsafe-fp-math\"=\"false\" \"use-soft-float\"=\"false\" }\nattributes #2 = { nounwind }\nattributes #3 = { optsize \"darwin-stkchk-strong-link\" \"disable-tail-calls\"=\"false\" \"frame-pointer\"=\"all\" \"less-precise-fpmad\"=\"false\" \"no-infs-fp-math\"=\"false\" \"no-nans-fp-math\"=\"false\" \"no-signed-zeros-fp-math\"=\"false\" \"no-trapping-math\"=\"true\" \"probe-stack\"=\"___chkstk_darwin\" \"stack-protector-buffer-size\"=\"8\" \"target-cpu\"=\"penryn\" \"target-features\"=\"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87\" \"tune-cpu\"=\"generic\" \"unsafe-fp-math\"=\"false\" \"use-soft-float\"=\"false\" }\nattributes #4 = { optsize }\n\n!llvm.module.flags = !{!0, !1, !2, !3, !4, !5, !6, !7}\n!llvm.ident = !{!8}\n\n!0 = !{i32 2, !\"SDK Version\", [2 x i32] [i32 12, i32 0]}\n!1 = !{i32 1, !\"Objective-C Version\", i32 2}\n!2 = !{i32 1, !\"Objective-C Image Info Version\", i32 0}\n!3 = !{i32 1, !\"Objective-C Image Info Section\", !\"__DATA,__objc_imageinfo,regular,no_dead_strip\"}\n!4 = !{i32 1, !\"Objective-C Garbage Collection\", i8 0}\n!5 = !{i32 1, !\"Objective-C Class Properties\", i32 64}\n!6 = !{i32 1, !\"wchar_size\", i32 4}\n!7 = !{i32 7, !\"PIC Level\", i32 2}\n!8 = !{!\"Apple clang version 13.0.0 (clang-1300.0.29.3)\"}\n!9 = !{}\n```\n\n**IR** 代码优化会调用相应 **Pass** 进行处理，**Pass** 由多个节点组成，都是 **Pass** 类的子类，每个节点负责特定的优化。这使得我们能够自主的控制优化的强度，在**Build Strrings -> Optimization Level** 中可指定优化程度，一些常见的代码优化方法如下：\n\n* 删除公共子表达式\n* 删除无用代码\n* 常量合并\n* 代码移动\n* 删除归纳变量\n\n#### 生成 BitCode（Archive时）\n\n```shell\nxrun clang -emit-llvm -c nihao.m -o nihao.bc\n```\n\n```\ndec0 170b 0000 0000 1400 0000 0010 0000\n0700 0001 4243 c0de 3514 0000 0700 0000\n620c 3024 9596 a6a5 f7d7 7f7d d3b4 4ffb\n76ef df3f 2d44 0132 0500 0000 210c 0000\n4903 0000 0b02 2100 0200 0000 1600 0000\n0781 2391 41c8 0449 0610 3239 9201 840c\n2505 0819 1e04 8b62 8014 4502 4292 0b42\na410 3214 3808 184b 0a32 5288 4870 c421\n...\n```\n\n**BitCode** 是 **LLVM** 引入的另一种中间代码，虽然看起来比较接近机器码，但是在函数和指令层面使用了很多高级语言的特性。\n\n但只会在 **Archive** 时，**BitCode** 才会被嵌入到链接后的二进制文件，用于提交给 **App Store**，包含 **Bitcode** 配置的程序将会在 **App Store** 上被重新编译和链接，进而对可执行文件做优化。值得注意的是，优化这一步是在 **App Store** 中做的处理，本地没有做处理。进行其他类型的 **Build** (非 **Archive** )时，编译器只会检查是否满足开启 **BitCode** 的条件，但并不会真正生成 **BitCode** 。\n\n### 3.4 LLVM Code Generator阶段\n\n#### 生成汇编代码\n\n```shell\nxcrun clang -S -fobjc-arc nihao.m -o nihao.s\n```\n\n```\n\t.section\t__TEXT,__text,regular,pure_instructions\n\t.build_version macos, 11, 0\tsdk_version 12, 0\n\t.globl\t_main                           ## -- Begin function main\n\t.p2align\t4, 0x90\n_main:                                  ## @main\n\t.cfi_startproc\n## %bb.0:\n\tpushq\t%rbp\n\t.cfi_def_cfa_offset 16\n\t.cfi_offset %rbp, -16\n\tmovq\t%rsp, %rbp\n\t.cfi_def_cfa_register %rbp\n\tsubq\t$32, %rsp\n\tmovl\t$0, -4(%rbp)\n\tmovl\t%edi, -8(%rbp)\n\tmovq\t%rsi, -16(%rbp)\n\tcallq\t_objc_autoreleasePoolPush\n\tmovq\t%rax, -24(%rbp)                 ## 8-byte Spill\n\tleaq\tL__unnamed_cfstring_(%rip), %rdi\n\tmovb\t$0, %al\n\tcallq\t_NSLog\n\tmovq\t-24(%rbp), %rdi                 ## 8-byte Reload\n\tmovl\t$0, -4(%rbp)\n\tcallq\t_objc_autoreleasePoolPop\n\tmovl\t-4(%rbp), %eax\n\taddq\t$32, %rsp\n\tpopq\t%rbp\n\tretq\n\t.cfi_endproc\n                                        ## -- End function\n\t.section\t__TEXT,__cstring,cstring_literals\nL_.str:                                 ## @.str\n\t.asciz\t\"nihao!!!\"\n\n\t.section\t__DATA,__cfstring\n\t.p2align\t3                               ## @_unnamed_cfstring_\nL__unnamed_cfstring_:\n\t.quad\t___CFConstantStringClassReference\n\t.long\t1992                            ## 0x7c8\n\t.space\t4\n\t.quad\tL_.str\n\t.quad\t8                               ## 0x8\n\n\t.section\t__DATA,__objc_imageinfo,regular,no_dead_strip\nL_OBJC_IMAGE_INFO:\n\t.long\t0\n\t.long\t64\n\n.subsections_via_symbols\n```\n\n汇编语言更加接近机器语言，能够直接对硬件进行操作，生成的程序与其他的语言相比具有更高的运行速度，占用更小的内存。\n\n目前所有 **iOS** 设备都采用 **ARM** 处理器，这意味着都是采用 **ARM** 指令集，如 **armv6 / armv7 / armv7s / arm64**，这些指令集都是向下兼容的。\n\n每种 **CPU** 架构都有着相应的指令集，可以针对不同的架构产生不同的汇编指令，加上上面 **- arch arch_type** 选项即可，更多请参见[官网](https://developer.apple.com/library/archive/documentation/DeveloperTools/Reference/Assembler/000-Introduction/introduction.html)。在 **Xcode** 中可在 **Build Settings -> Architectrues** 指定产生的 **CPU** 指令集。\n\n#### 生成机器代码\n\n```shell\nxcrun clang -fmodules -c nihao.s -o nihao.o\n```\n\n可以发现机器码二进制文件无法阅读，可借助 **otool** 或者 **MachOView** 等工具查看文件中的相关内容：\n\n```shell\notool -v -h nihao.o\n```\n\n```\nnihao.o:\nMach header\n      magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags\nMH_MAGIC_64   X86_64        ALL  0x00      OBJECT     4        680 SUBSECTIONS_VIA_SYMBOLS\n```\n\n可以看见 **.o** 文件实际上是 **mach-o** 格式，这里我们输入可执行文件的头部，规定了这个文件是什么，适应架构的相关信息，以及文件是如何被加载的。更多关于 **mach-o** 的知识[参见](https://www.jianshu.com/p/54d842db3f69)。\n\n#### 链接\n\n```shell\nxcrun clang nihao.o -Wl,`xcrun --show-sdk-path`/System/Library/Frameworks/Foundation.framework/Foundation\n```\n\n```shell\n./a.out\n```\n\n```\n2021-11-03 16:06:41.734 a.out[6394:220026] nihao!!!\n```\n\n由于我们引入了 **Foundation** 里面的文件，所以需要将目标文件和 **Foundation framework**进行链接，接着就可以运行我们的程序了。\n\n这里涉及到一个概念：符号表，里面存储的元素如下：\n\n```xml\n<起始地址> <结束地址> <函数> [<文件名:行号>]\n```\n\n这里我们输入a.out的符号信息\n\n```\nnm -nm a.out\n```\n\n```\n                 (undefined) external _NSLog (from Foundation)\n                 (undefined) external ___CFConstantStringClassReference (from CoreFoundation)\n                 (undefined) external _objc_autoreleasePoolPop (from libobjc)\n                 (undefined) external _objc_autoreleasePoolPush (from libobjc)\n                 (undefined) external dyld_stub_binder (from libSystem)\n0000000100000000 (__TEXT,__text) [referenced dynamically] external __mh_execute_header\n0000000100003f20 (__TEXT,__text) external _main\n0000000100008018 (__DATA,__data) non-external __dyld_private\n```\n\n对于动态链接库的符号（如 **Foundation**），最终会记录下这个符号是通过进行链接的，并记录下依赖于哪个动态链接库。在运行时，动态链接器（**dyld**）会去解析这些 **undefined** 符号。对于其他位置的符号，会直接修正这些符号的具体位置信息。\n\n## 4. 总结\n\n本文介绍了关于 iOS 编译器、iOS 编译过程的基础知识。学习了这些，对 iOS 编译有个整体认识。就本人而言，在一路搜寻资料的过程中，对之前一些零散的知识点有了一些更加深入的认识。由于篇幅有限，关于 SwiftC 的编译过程没有多做介绍，后面会再出一篇进行介绍。\n\n\n\n🔗：\n\n[ObjC 中国 - Mach-O 可执行文件](https://objccn.io/issue-6-3/)\n\n[代码优化与LLVM IR pass](https://kiprey.github.io/2020/06/LLVM-IR-pass/)\n\n[关于bitcode, 知道这些就够了](http://xelz.info/blog/2018/11/24/all-you-need-to-know-about-bitcode/)\n\n[iOS 编译链接：Objective-C 编译链接](https://zhuanlan.zhihu.com/p/340782811)\n\n[趣探 Mach-O：文件格式分析](https://www.jianshu.com/p/54d842db3f69)\n\n","source":"_posts/2021-11-03-iOS编译过程.md","raw":"---\ntitle: \"iOS 编译过程\"\ncategories:\n  - iOS\ntags:\n  - iOS\n  - Compile\n---\n\n# iOS 编译过程 \n\n## 1. 前言\n\n学习 **iOS** 编译过程（**Compile**）有助于我们更好理解代码是如何被计算机运作起来，编译器为代码做了哪些优化，让我们学会从另一个角度来看待问题。\n\n## 2. 编译器结构\n\n现代编译器是将源代码转换成可执行文件的程序，工作流程主要分为 **前端** 和 **后端** 两个部分：\n\n1. 前端：对源代码进行解析，并生成中间代码。\n2. 后端：针对中间代码进行优化，并转换成目标机器的代码指令。\n\n```mermaid\ngraph LR\n\tA(SourceCode) --> B(Frontend)\n    B(Frontend) --> C(Backend)\n    C(Backend) --> D(Machine Code)\n```\n\n针对iOS平台，不同语言采用了不同的编译器前端：\n\n1. **Frontend：Clang / SwiftC**\n\n   对于 **Objective-C / C / C++ / Objective-C++**  来说采用 **Clang** 编译器前端；\n\n   对于 **Swift** 来说则采用 **SwiftC**；\n\n2. **Backend：LLVM**\n\n   无论是 **C** 系语言还是 **Swift** 都采用 **LLVM** 作为编译器后端；\n\n值得注意的是在 **Xcode3** 以前，都采用 **GCC** 作为编译器前端，但为 **Apple** 快速发展需要功能更强大和性能更好的编译器，所以 **Apple** 自己开发了 **Clang** 作为编译器前端。下面对编译器做一个简要介绍：\n\n* **GCC**\n\n**GCC**（**GNU Compile Collection**，**GNU **编译器套装），是一套由 **GNU** 开发的编程语言编译器。来本只能处理 *C* 语言，后来快速演进，变得可处理 **C++、Objective-C、Java、Fortran** 等其他语言。但由于一些缺陷，导致了 **Apple** 抛弃了 **GCC** ，开发出了 **Clang** 作为其前端编译器。\n\n1. **GCC** 的 **Objective-C Frontend** 不是 **Apple** 维护，导致想要添加一些语法提示等功能得去要求 **GCC** 团队做。\n2. **GCC** 的插件、工具、**IDE** 的支持薄弱。\n3. **GCC** 的编译效率和性能不足。\n\n* **Clang**\n\n**Clang1.0** 于 **2009** 年正式与 **LLVM2.6** 正式发布，旨在提供 **GCC** 的替代品，支持了 **GUN** 编译器大多数的编译器设置以及非官方语言的拓展，相较于 **GCC** ，**Clang** 具有以下优势：\n\n1. 编译速度更快。\n2. 占用内存更小。\n3. 模块化设计，易于拓展与重用。\n4. 诊断信息可读性强。\n\n* **SwiftC**\n\n**SwiftC** 在前端采用了 **SIL** 中间语言，这是因为 **Swift** 作为一种高级语言，有许多特性，如 **protocol** 的泛型，也是一门安全的语言，确保变量在使用之前被初始化、检测不可执行的代码，于是增加了一层 **SIL** 来做这些事情。\n\n* **LLVM**\n\n**LLVM** 是一套编译器基础设备项目，由 **C++** 写成，包含一系列模块化的编译器组件和工具链，用来开发编译器的前端和后端。在 **iOS** 中，**LLVM** 作为编译器后端主要提供 **Optimizer** 和 **Code Generator** ，将接收到的 **IR** 中间代码进行优化，以及机器代码生成。\n\n## 3. 编译过程\n\n### 3.1 流程梳理\n\n```mermaid\ngraph TD\n    subgraph Clang\n\tid1(源代码) --> id2(预处理) \n    id2(预处理) --> id3(语法分析)   \n    id3(语法分析) --  token  --> id4(语法分析)\n    id4(语法分析) --  AST  --> id5(中间代码生成)\n    end\n    \n    subgraph Optimizer, Backend\n    id6(中间代码优化) --> id7(BitCode生成)\n    id7(BitCode生成) --> id8(汇编指令生成)\n    id8(汇编指令生成) --> id9(机器码生成)\n    id9(机器码生成) --> id11(链接生成可执行文件)\n    end\n    \n    subgraph SwiftC\n    id12(源代码) --> id13(解析)\n    id13(解析) --> id14(语义分析)\n    id14(语义分析) --> id15(Clang导入器)\n    id15(Clang导入器) --> id16(SIL生成)\n    id16(SIL生成) --> id17(SIL保证转换)\n    id17 --> id18(SIL优化)\n    id18(SIL优化) --> id19(中间代码生成)\n    end\n    \n    id5 --  IR  --> id6\n    id19 --  IR  --> id6\n```\n\n在前端 **Objective-C** 和 **Swift** 分别由自己的处理阶段，但最后都会生成 **IR** 中间代码，交由后端进行统一处理。\n\n下面我们从一个简单的.m文件进行编译过程梳理，首先在某一个目录下创建一个 **nihao.m**文件\n\n```shell\ntouch nihao.m\n```\n\n**nihao.m：**\n\n```objective-c\n#import <Foundation/Foundation.h>\nint main(int argc, char *argv[])\n{\n    @autoreleasepool {\n        NSLog(@\"nihao!!!\");\n        return 0;\n    }\n}\n```\n\n### 3.2 Clang阶段（Objective-C / C++ / C / Objective-C++）\n\n#### 预处理阶段：\n\n```shell\nxcrun clang -E helloworld.c | open -f\n```\n\n```\n# 1 \"nihao.m\"\n# 1 \"<built-in>\" 1\n# 1 \"<built-in>\" 3\n# 380 \"<built-in>\" 3\n# 1 \"<command line>\" 1\n# 1 \"<built-in>\" 2\n# 1 \"nihao.m\" 2\n# 1 \"/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/System/Library/Frameworks/Foundation.framework/Headers/Foundation.h\" 1 3\n\n...\n...\n...\n\nint main(int argc, char *argv[])\n{\n    @autoreleasepool {\n        NSLog(@\"nihao!!!\");\n        return 0;\n    }\n}\n```\n\n将预处理阶段输出到文件， 可以看到很多以 **#** 开头的语句，这些语句告诉我们后面跟着的内容来自哪里，这里可以看见 **Foundation.h** 文件的内容也包含了进来。在 **Xcode** 中，也可以通过 **Product ->  Perfrom Action -> Preprocess** 查看预处理阶段之后的代码。在预处理阶段做了以下这些事情：\n\n* 将头文件引入的其他文件加入源文件中，是一个递归的过程。\n* 进行条件编译处理。\n* 将宏定义直接替换，不进行语法检查。\n* 将注释进行删除处理。\n\n#### 词法分析阶段\n\n```shell\nxcrun clang -fmodules -fsyntax-only -Xclang -dump-tokens nihao.m\n```\n\n```\nannot_module_include '#import <Foundation/Foundation.h>\n\n'\t\tLoc=<nihao.m:1:1>\nint 'int'\t [StartOfLine]\tLoc=<nihao.m:3:1>\nidentifier 'main'\t [LeadingSpace]\tLoc=<nihao.m:3:5>\nl_paren '('\t\tLoc=<nihao.m:3:9>\nint 'int'\t\tLoc=<nihao.m:3:10>\nidentifier 'argc'\t [LeadingSpace]\tLoc=<nihao.m:3:14>\ncomma ','\t\tLoc=<nihao.m:3:18>\nchar 'char'\t [LeadingSpace]\tLoc=<nihao.m:3:20>\nstar '*'\t [LeadingSpace]\tLoc=<nihao.m:3:25>\nidentifier 'argv'\t\tLoc=<nihao.m:3:26>\nl_square '['\t\tLoc=<nihao.m:3:30>\nr_square ']'\t\tLoc=<nihao.m:3:31>\nr_paren ')'\t\tLoc=<nihao.m:3:32>\nl_brace '{'\t [StartOfLine]\tLoc=<nihao.m:4:1>\nat '@'\t [StartOfLine] [LeadingSpace]\tLoc=<nihao.m:5:5>\nidentifier 'autoreleasepool'\t\tLoc=<nihao.m:5:6>\n...\n```\n\n词法分析阶段其实是将源代码以字符文本的形式转换成 **Token** 流的形式，不涉及语义校验，用来标识出这个字符是标识符、括号、if语句...，最后还会标识出其所在位置，方便后续分析能够找出出错的原始位置。\n\n#### 语法分析阶段\n\n```\nxcrun clang -fsyntax-only -Xclang -ast-dump nihao.m | open -f\n```\n\n```\n...\n`-FunctionDecl 0x7f9eb4bd61a0 <nihao.m:3:1, line:9:1> line:3:5 main 'int (int, char **)'\n  |-ParmVarDecl 0x7f9eb4bd5fc0 <col:10, col:14> col:14 argc 'int'\n  |-ParmVarDecl 0x7f9eb4bd6080 <col:20, col:31> col:26 argv 'char **':'char **'\n  `-CompoundStmt 0x7f9eb4bd63d0 <line:4:1, line:9:1>\n    `-ObjCAutoreleasePoolStmt 0x7f9eb4bd63b8 <line:5:5, line:8:5>\n      `-CompoundStmt 0x7f9eb4bd6398 <line:5:22, line:8:5>\n        |-CallExpr 0x7f9eb4bd6328 <line:6:9, col:26> 'void'\n        | |-ImplicitCastExpr 0x7f9eb4bd6310 <col:9> 'void (*)(id, ...)' <FunctionToPointerDecay>\n        | | `-DeclRefExpr 0x7f9eb4bd6250 <col:9> 'void (id, ...)' Function 0x7f9eb0c8d6c8 'NSLog' 'void (id, ...)'\n        | `-ImplicitCastExpr 0x7f9eb4bd6350 <col:15, col:16> 'id':'id' <BitCast>\n        |   `-ObjCStringLiteral 0x7f9eb4bd6290 <col:15, col:16> 'NSString *'\n        |     `-StringLiteral 0x7f9eb4bd6270 <col:16> 'char [9]' lvalue \"nihao!!!\"\n        `-ReturnStmt 0x7f9eb4bd6388 <line:7:9, col:16>\n          `-IntegerLiteral 0x7f9eb4bd6368 <col:16> 'int' 0\n```\n\n语法分析阶段会输出 **AST**（抽象语法树），它是源代码语法结构的一种抽象表示。它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。通过它，可以进行语法错误分析，以及静态分析操作，涵盖内存操作和安全等方面。\n\n#### CodeGen阶段\n\n```shell\nxcrun clang -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll\n```\n\n```\n; ModuleID = 'nihao.m'\nsource_filename = \"nihao.m\"\ntarget datalayout = \"e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128\"\ntarget triple = \"x86_64-apple-macosx11.0.0\"\n\n%struct.__NSConstantString_tag = type { i32*, i32, i8*, i64 }\n\n@__CFConstantStringClassReference = external global [0 x i32]\n@.str = private unnamed_addr constant [9 x i8] c\"nihao!!!\\00\", section \"__TEXT,__cstring,cstring_literals\", align 1\n@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag { i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 }, section \"__DATA,__cfstring\", align 8 #0\n\n; Function Attrs: noinline optnone ssp uwtable\ndefine i32 @main(i32 %0, i8** %1) #1 {\n  %3 = alloca i32, align 4\n  %4 = alloca i32, align 4\n  %5 = alloca i8**, align 8\n  store i32 0, i32* %3, align 4\n  store i32 %0, i32* %4, align 4\n  store i8** %1, i8*** %5, align 8\n  %6 = call i8* @llvm.objc.autoreleasePoolPush() #2\n  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*))\n  store i32 0, i32* %3, align 4\n  call void @llvm.objc.autoreleasePoolPop(i8* %6)\n  %7 = load i32, i32* %3, align 4\n  ret i32 %7\n}\n\n; Function Attrs: nounwind\ndeclare i8* @llvm.objc.autoreleasePoolPush() #2\n\ndeclare void @NSLog(i8*, ...) #3\n\n; Function Attrs: nounwind\ndeclare void @llvm.objc.autoreleasePoolPop(i8*) #2\n\nattributes #0 = { \"objc_arc_inert\" }\nattributes #1 = { noinline optnone ssp uwtable \"darwin-stkchk-strong-link\" \"disable-tail-calls\"=\"false\" \"frame-pointer\"=\"all\" \"less-precise-fpmad\"=\"false\" \"min-legal-vector-width\"=\"0\" \"no-infs-fp-math\"=\"false\" \"no-jump-tables\"=\"false\" \"no-nans-fp-math\"=\"false\" \"no-signed-zeros-fp-math\"=\"false\" \"no-trapping-math\"=\"true\" \"probe-stack\"=\"___chkstk_darwin\" \"stack-protector-buffer-size\"=\"8\" \"target-cpu\"=\"penryn\" \"target-features\"=\"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87\" \"tune-cpu\"=\"generic\" \"unsafe-fp-math\"=\"false\" \"use-soft-float\"=\"false\" }\nattributes #2 = { nounwind }\nattributes #3 = { \"darwin-stkchk-strong-link\" \"disable-tail-calls\"=\"false\" \"frame-pointer\"=\"all\" \"less-precise-fpmad\"=\"false\" \"no-infs-fp-math\"=\"false\" \"no-nans-fp-math\"=\"false\" \"no-signed-zeros-fp-math\"=\"false\" \"no-trapping-math\"=\"true\" \"probe-stack\"=\"___chkstk_darwin\" \"stack-protector-buffer-size\"=\"8\" \"target-cpu\"=\"penryn\" \"target-features\"=\"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87\" \"tune-cpu\"=\"generic\" \"unsafe-fp-math\"=\"false\" \"use-soft-float\"=\"false\" }\n\n!llvm.module.flags = !{!0, !1, !2, !3, !4, !5, !6, !7}\n!llvm.ident = !{!8}\n\n!0 = !{i32 2, !\"SDK Version\", [2 x i32] [i32 12, i32 0]}\n!1 = !{i32 1, !\"Objective-C Version\", i32 2}\n!2 = !{i32 1, !\"Objective-C Image Info Version\", i32 0}\n!3 = !{i32 1, !\"Objective-C Image Info Section\", !\"__DATA,__objc_imageinfo,regular,no_dead_strip\"}\n!4 = !{i32 1, !\"Objective-C Garbage Collection\", i8 0}\n!5 = !{i32 1, !\"Objective-C Class Properties\", i32 64}\n!6 = !{i32 1, !\"wchar_size\", i32 4}\n!7 = !{i32 7, !\"PIC Level\", i32 2}\n!8 = !{!\"Apple clang version 13.0.0 (clang-1300.0.29.3)\"}\n```\n\n**CodeGen** 阶段负责将 **AST** 自顶向下遍历逐步翻译成 **LLVM IR**，也就是编译器后端所需要的中间代码，同时 **Objective-C** 代码也会在这一步进行 **Runtime** 桥接： **property** 合成，**ARC** 处理等，如上方可以看见 **autoreleasePoolPush** 、 **autoreleasePoolPop** 操作。\n\n至此 **Clang** 前端工作算是完成，接下来就交给后端进行处理。\n\n### 3.3 LLVM Optimizer 阶段\n\n#### IR代码优化\n\n```shell\nxcrun clang -Os -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll\n```\n\n```\n; ModuleID = 'nihao.m'\nsource_filename = \"nihao.m\"\ntarget datalayout = \"e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128\"\ntarget triple = \"x86_64-apple-macosx11.0.0\"\n\n%struct.__NSConstantString_tag = type { i32*, i32, i8*, i64 }\n\n@__CFConstantStringClassReference = external global [0 x i32]\n@.str = private unnamed_addr constant [9 x i8] c\"nihao!!!\\00\", section \"__TEXT,__cstring,cstring_literals\", align 1\n@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag { i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 }, section \"__DATA,__cfstring\", align 8 #0\n\n; Function Attrs: optsize ssp uwtable\ndefine i32 @main(i32 %0, i8** nocapture readnone %1) local_unnamed_addr #1 {\n  %3 = tail call i8* @llvm.objc.autoreleasePoolPush() #2\n  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*)) #4, !clang.arc.no_objc_arc_exceptions !9\n  tail call void @llvm.objc.autoreleasePoolPop(i8* %3) #2\n  ret i32 0\n}\n\n; Function Attrs: nounwind\ndeclare i8* @llvm.objc.autoreleasePoolPush() #2\n\n; Function Attrs: optsize\ndeclare void @NSLog(i8*, ...) local_unnamed_addr #3\n\n; Function Attrs: nounwind\ndeclare void @llvm.objc.autoreleasePoolPop(i8*) #2\n\nattributes #0 = { \"objc_arc_inert\" }\nattributes #1 = { optsize ssp uwtable \"darwin-stkchk-strong-link\" \"disable-tail-calls\"=\"false\" \"frame-pointer\"=\"all\" \"less-precise-fpmad\"=\"false\" \"min-legal-vector-width\"=\"0\" \"no-infs-fp-math\"=\"false\" \"no-jump-tables\"=\"false\" \"no-nans-fp-math\"=\"false\" \"no-signed-zeros-fp-math\"=\"false\" \"no-trapping-math\"=\"true\" \"probe-stack\"=\"___chkstk_darwin\" \"stack-protector-buffer-size\"=\"8\" \"target-cpu\"=\"penryn\" \"target-features\"=\"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87\" \"tune-cpu\"=\"generic\" \"unsafe-fp-math\"=\"false\" \"use-soft-float\"=\"false\" }\nattributes #2 = { nounwind }\nattributes #3 = { optsize \"darwin-stkchk-strong-link\" \"disable-tail-calls\"=\"false\" \"frame-pointer\"=\"all\" \"less-precise-fpmad\"=\"false\" \"no-infs-fp-math\"=\"false\" \"no-nans-fp-math\"=\"false\" \"no-signed-zeros-fp-math\"=\"false\" \"no-trapping-math\"=\"true\" \"probe-stack\"=\"___chkstk_darwin\" \"stack-protector-buffer-size\"=\"8\" \"target-cpu\"=\"penryn\" \"target-features\"=\"+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87\" \"tune-cpu\"=\"generic\" \"unsafe-fp-math\"=\"false\" \"use-soft-float\"=\"false\" }\nattributes #4 = { optsize }\n\n!llvm.module.flags = !{!0, !1, !2, !3, !4, !5, !6, !7}\n!llvm.ident = !{!8}\n\n!0 = !{i32 2, !\"SDK Version\", [2 x i32] [i32 12, i32 0]}\n!1 = !{i32 1, !\"Objective-C Version\", i32 2}\n!2 = !{i32 1, !\"Objective-C Image Info Version\", i32 0}\n!3 = !{i32 1, !\"Objective-C Image Info Section\", !\"__DATA,__objc_imageinfo,regular,no_dead_strip\"}\n!4 = !{i32 1, !\"Objective-C Garbage Collection\", i8 0}\n!5 = !{i32 1, !\"Objective-C Class Properties\", i32 64}\n!6 = !{i32 1, !\"wchar_size\", i32 4}\n!7 = !{i32 7, !\"PIC Level\", i32 2}\n!8 = !{!\"Apple clang version 13.0.0 (clang-1300.0.29.3)\"}\n!9 = !{}\n```\n\n**IR** 代码优化会调用相应 **Pass** 进行处理，**Pass** 由多个节点组成，都是 **Pass** 类的子类，每个节点负责特定的优化。这使得我们能够自主的控制优化的强度，在**Build Strrings -> Optimization Level** 中可指定优化程度，一些常见的代码优化方法如下：\n\n* 删除公共子表达式\n* 删除无用代码\n* 常量合并\n* 代码移动\n* 删除归纳变量\n\n#### 生成 BitCode（Archive时）\n\n```shell\nxrun clang -emit-llvm -c nihao.m -o nihao.bc\n```\n\n```\ndec0 170b 0000 0000 1400 0000 0010 0000\n0700 0001 4243 c0de 3514 0000 0700 0000\n620c 3024 9596 a6a5 f7d7 7f7d d3b4 4ffb\n76ef df3f 2d44 0132 0500 0000 210c 0000\n4903 0000 0b02 2100 0200 0000 1600 0000\n0781 2391 41c8 0449 0610 3239 9201 840c\n2505 0819 1e04 8b62 8014 4502 4292 0b42\na410 3214 3808 184b 0a32 5288 4870 c421\n...\n```\n\n**BitCode** 是 **LLVM** 引入的另一种中间代码，虽然看起来比较接近机器码，但是在函数和指令层面使用了很多高级语言的特性。\n\n但只会在 **Archive** 时，**BitCode** 才会被嵌入到链接后的二进制文件，用于提交给 **App Store**，包含 **Bitcode** 配置的程序将会在 **App Store** 上被重新编译和链接，进而对可执行文件做优化。值得注意的是，优化这一步是在 **App Store** 中做的处理，本地没有做处理。进行其他类型的 **Build** (非 **Archive** )时，编译器只会检查是否满足开启 **BitCode** 的条件，但并不会真正生成 **BitCode** 。\n\n### 3.4 LLVM Code Generator阶段\n\n#### 生成汇编代码\n\n```shell\nxcrun clang -S -fobjc-arc nihao.m -o nihao.s\n```\n\n```\n\t.section\t__TEXT,__text,regular,pure_instructions\n\t.build_version macos, 11, 0\tsdk_version 12, 0\n\t.globl\t_main                           ## -- Begin function main\n\t.p2align\t4, 0x90\n_main:                                  ## @main\n\t.cfi_startproc\n## %bb.0:\n\tpushq\t%rbp\n\t.cfi_def_cfa_offset 16\n\t.cfi_offset %rbp, -16\n\tmovq\t%rsp, %rbp\n\t.cfi_def_cfa_register %rbp\n\tsubq\t$32, %rsp\n\tmovl\t$0, -4(%rbp)\n\tmovl\t%edi, -8(%rbp)\n\tmovq\t%rsi, -16(%rbp)\n\tcallq\t_objc_autoreleasePoolPush\n\tmovq\t%rax, -24(%rbp)                 ## 8-byte Spill\n\tleaq\tL__unnamed_cfstring_(%rip), %rdi\n\tmovb\t$0, %al\n\tcallq\t_NSLog\n\tmovq\t-24(%rbp), %rdi                 ## 8-byte Reload\n\tmovl\t$0, -4(%rbp)\n\tcallq\t_objc_autoreleasePoolPop\n\tmovl\t-4(%rbp), %eax\n\taddq\t$32, %rsp\n\tpopq\t%rbp\n\tretq\n\t.cfi_endproc\n                                        ## -- End function\n\t.section\t__TEXT,__cstring,cstring_literals\nL_.str:                                 ## @.str\n\t.asciz\t\"nihao!!!\"\n\n\t.section\t__DATA,__cfstring\n\t.p2align\t3                               ## @_unnamed_cfstring_\nL__unnamed_cfstring_:\n\t.quad\t___CFConstantStringClassReference\n\t.long\t1992                            ## 0x7c8\n\t.space\t4\n\t.quad\tL_.str\n\t.quad\t8                               ## 0x8\n\n\t.section\t__DATA,__objc_imageinfo,regular,no_dead_strip\nL_OBJC_IMAGE_INFO:\n\t.long\t0\n\t.long\t64\n\n.subsections_via_symbols\n```\n\n汇编语言更加接近机器语言，能够直接对硬件进行操作，生成的程序与其他的语言相比具有更高的运行速度，占用更小的内存。\n\n目前所有 **iOS** 设备都采用 **ARM** 处理器，这意味着都是采用 **ARM** 指令集，如 **armv6 / armv7 / armv7s / arm64**，这些指令集都是向下兼容的。\n\n每种 **CPU** 架构都有着相应的指令集，可以针对不同的架构产生不同的汇编指令，加上上面 **- arch arch_type** 选项即可，更多请参见[官网](https://developer.apple.com/library/archive/documentation/DeveloperTools/Reference/Assembler/000-Introduction/introduction.html)。在 **Xcode** 中可在 **Build Settings -> Architectrues** 指定产生的 **CPU** 指令集。\n\n#### 生成机器代码\n\n```shell\nxcrun clang -fmodules -c nihao.s -o nihao.o\n```\n\n可以发现机器码二进制文件无法阅读，可借助 **otool** 或者 **MachOView** 等工具查看文件中的相关内容：\n\n```shell\notool -v -h nihao.o\n```\n\n```\nnihao.o:\nMach header\n      magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags\nMH_MAGIC_64   X86_64        ALL  0x00      OBJECT     4        680 SUBSECTIONS_VIA_SYMBOLS\n```\n\n可以看见 **.o** 文件实际上是 **mach-o** 格式，这里我们输入可执行文件的头部，规定了这个文件是什么，适应架构的相关信息，以及文件是如何被加载的。更多关于 **mach-o** 的知识[参见](https://www.jianshu.com/p/54d842db3f69)。\n\n#### 链接\n\n```shell\nxcrun clang nihao.o -Wl,`xcrun --show-sdk-path`/System/Library/Frameworks/Foundation.framework/Foundation\n```\n\n```shell\n./a.out\n```\n\n```\n2021-11-03 16:06:41.734 a.out[6394:220026] nihao!!!\n```\n\n由于我们引入了 **Foundation** 里面的文件，所以需要将目标文件和 **Foundation framework**进行链接，接着就可以运行我们的程序了。\n\n这里涉及到一个概念：符号表，里面存储的元素如下：\n\n```xml\n<起始地址> <结束地址> <函数> [<文件名:行号>]\n```\n\n这里我们输入a.out的符号信息\n\n```\nnm -nm a.out\n```\n\n```\n                 (undefined) external _NSLog (from Foundation)\n                 (undefined) external ___CFConstantStringClassReference (from CoreFoundation)\n                 (undefined) external _objc_autoreleasePoolPop (from libobjc)\n                 (undefined) external _objc_autoreleasePoolPush (from libobjc)\n                 (undefined) external dyld_stub_binder (from libSystem)\n0000000100000000 (__TEXT,__text) [referenced dynamically] external __mh_execute_header\n0000000100003f20 (__TEXT,__text) external _main\n0000000100008018 (__DATA,__data) non-external __dyld_private\n```\n\n对于动态链接库的符号（如 **Foundation**），最终会记录下这个符号是通过进行链接的，并记录下依赖于哪个动态链接库。在运行时，动态链接器（**dyld**）会去解析这些 **undefined** 符号。对于其他位置的符号，会直接修正这些符号的具体位置信息。\n\n## 4. 总结\n\n本文介绍了关于 iOS 编译器、iOS 编译过程的基础知识。学习了这些，对 iOS 编译有个整体认识。就本人而言，在一路搜寻资料的过程中，对之前一些零散的知识点有了一些更加深入的认识。由于篇幅有限，关于 SwiftC 的编译过程没有多做介绍，后面会再出一篇进行介绍。\n\n\n\n🔗：\n\n[ObjC 中国 - Mach-O 可执行文件](https://objccn.io/issue-6-3/)\n\n[代码优化与LLVM IR pass](https://kiprey.github.io/2020/06/LLVM-IR-pass/)\n\n[关于bitcode, 知道这些就够了](http://xelz.info/blog/2018/11/24/all-you-need-to-know-about-bitcode/)\n\n[iOS 编译链接：Objective-C 编译链接](https://zhuanlan.zhihu.com/p/340782811)\n\n[趣探 Mach-O：文件格式分析](https://www.jianshu.com/p/54d842db3f69)\n\n","slug":"2021-11-03-iOS编译过程","published":1,"date":"2021-11-02T02:35:36.461Z","updated":"2021-11-04T06:32:54.165Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckvko2j290001qezucdkignnj","content":"\n        <h1 id=\"iOS-编译过程\"   >\n          <a href=\"#iOS-编译过程\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#iOS-编译过程\" class=\"headerlink\" title=\"iOS 编译过程\"></a>iOS 编译过程</h1>\n      \n        <h2 id=\"1-前言\"   >\n          <a href=\"#1-前言\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#1-前言\" class=\"headerlink\" title=\"1. 前言\"></a>1. 前言</h2>\n      <p>学习 <strong>iOS</strong> 编译过程（<strong>Compile</strong>）有助于我们更好理解代码是如何被计算机运作起来，编译器为代码做了哪些优化，让我们学会从另一个角度来看待问题。</p>\n\n        <h2 id=\"2-编译器结构\"   >\n          <a href=\"#2-编译器结构\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#2-编译器结构\" class=\"headerlink\" title=\"2. 编译器结构\"></a>2. 编译器结构</h2>\n      <p>现代编译器是将源代码转换成可执行文件的程序，工作流程主要分为 <strong>前端</strong> 和 <strong>后端</strong> 两个部分：</p>\n<ol>\n<li>前端：对源代码进行解析，并生成中间代码。</li>\n<li>后端：针对中间代码进行优化，并转换成目标机器的代码指令。</li>\n</ol>\n<pre class=\"mermaid\">graph LR\n    A(SourceCode) --> B(Frontend)\n    B(Frontend) --> C(Backend)\n    C(Backend) --> D(Machine Code)</pre>\n\n<p>针对iOS平台，不同语言采用了不同的编译器前端：</p>\n<ol>\n<li><p><strong>Frontend：Clang / SwiftC</strong></p>\n<p>对于 <strong>Objective-C / C / C++ / Objective-C++</strong>  来说采用 <strong>Clang</strong> 编译器前端；</p>\n<p>对于 <strong>Swift</strong> 来说则采用 <strong>SwiftC</strong>；</p>\n</li>\n<li><p><strong>Backend：LLVM</strong></p>\n<p>无论是 <strong>C</strong> 系语言还是 <strong>Swift</strong> 都采用 <strong>LLVM</strong> 作为编译器后端；</p>\n</li>\n</ol>\n<p>值得注意的是在 <strong>Xcode3</strong> 以前，都采用 <strong>GCC</strong> 作为编译器前端，但为 <strong>Apple</strong> 快速发展需要功能更强大和性能更好的编译器，所以 <strong>Apple</strong> 自己开发了 <strong>Clang</strong> 作为编译器前端。下面对编译器做一个简要介绍：</p>\n<ul>\n<li><strong>GCC</strong></li>\n</ul>\n<p><strong>GCC</strong>（<strong>GNU Compile Collection</strong>，**GNU **编译器套装），是一套由 <strong>GNU</strong> 开发的编程语言编译器。来本只能处理 <em>C</em> 语言，后来快速演进，变得可处理 <strong>C++、Objective-C、Java、Fortran</strong> 等其他语言。但由于一些缺陷，导致了 <strong>Apple</strong> 抛弃了 <strong>GCC</strong> ，开发出了 <strong>Clang</strong> 作为其前端编译器。</p>\n<ol>\n<li><strong>GCC</strong> 的 <strong>Objective-C Frontend</strong> 不是 <strong>Apple</strong> 维护，导致想要添加一些语法提示等功能得去要求 <strong>GCC</strong> 团队做。</li>\n<li><strong>GCC</strong> 的插件、工具、<strong>IDE</strong> 的支持薄弱。</li>\n<li><strong>GCC</strong> 的编译效率和性能不足。</li>\n</ol>\n<ul>\n<li><strong>Clang</strong></li>\n</ul>\n<p><strong>Clang1.0</strong> 于 <strong>2009</strong> 年正式与 <strong>LLVM2.6</strong> 正式发布，旨在提供 <strong>GCC</strong> 的替代品，支持了 <strong>GUN</strong> 编译器大多数的编译器设置以及非官方语言的拓展，相较于 <strong>GCC</strong> ，<strong>Clang</strong> 具有以下优势：</p>\n<ol>\n<li>编译速度更快。</li>\n<li>占用内存更小。</li>\n<li>模块化设计，易于拓展与重用。</li>\n<li>诊断信息可读性强。</li>\n</ol>\n<ul>\n<li><strong>SwiftC</strong></li>\n</ul>\n<p><strong>SwiftC</strong> 在前端采用了 <strong>SIL</strong> 中间语言，这是因为 <strong>Swift</strong> 作为一种高级语言，有许多特性，如 <strong>protocol</strong> 的泛型，也是一门安全的语言，确保变量在使用之前被初始化、检测不可执行的代码，于是增加了一层 <strong>SIL</strong> 来做这些事情。</p>\n<ul>\n<li><strong>LLVM</strong></li>\n</ul>\n<p><strong>LLVM</strong> 是一套编译器基础设备项目，由 <strong>C++</strong> 写成，包含一系列模块化的编译器组件和工具链，用来开发编译器的前端和后端。在 <strong>iOS</strong> 中，<strong>LLVM</strong> 作为编译器后端主要提供 <strong>Optimizer</strong> 和 <strong>Code Generator</strong> ，将接收到的 <strong>IR</strong> 中间代码进行优化，以及机器代码生成。</p>\n\n        <h2 id=\"3-编译过程\"   >\n          <a href=\"#3-编译过程\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#3-编译过程\" class=\"headerlink\" title=\"3. 编译过程\"></a>3. 编译过程</h2>\n      \n        <h3 id=\"3-1-流程梳理\"   >\n          <a href=\"#3-1-流程梳理\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#3-1-流程梳理\" class=\"headerlink\" title=\"3.1 流程梳理\"></a>3.1 流程梳理</h3>\n      <pre class=\"mermaid\">graph TD\n    subgraph Clang\n    id1(源代码) --> id2(预处理) \n    id2(预处理) --> id3(语法分析)   \n    id3(语法分析) --  token  --> id4(语法分析)\n    id4(语法分析) --  AST  --> id5(中间代码生成)\n    end\n    \n    subgraph Optimizer, Backend\n    id6(中间代码优化) --> id7(BitCode生成)\n    id7(BitCode生成) --> id8(汇编指令生成)\n    id8(汇编指令生成) --> id9(机器码生成)\n    id9(机器码生成) --> id11(链接生成可执行文件)\n    end\n    \n    subgraph SwiftC\n    id12(源代码) --> id13(解析)\n    id13(解析) --> id14(语义分析)\n    id14(语义分析) --> id15(Clang导入器)\n    id15(Clang导入器) --> id16(SIL生成)\n    id16(SIL生成) --> id17(SIL保证转换)\n    id17 --> id18(SIL优化)\n    id18(SIL优化) --> id19(中间代码生成)\n    end\n    \n    id5 --  IR  --> id6\n    id19 --  IR  --> id6</pre>\n\n<p>在前端 <strong>Objective-C</strong> 和 <strong>Swift</strong> 分别由自己的处理阶段，但最后都会生成 <strong>IR</strong> 中间代码，交由后端进行统一处理。</p>\n<p>下面我们从一个简单的.m文件进行编译过程梳理，首先在某一个目录下创建一个 <strong>nihao.m</strong>文件</p>\n<figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">touch nihao.m</span><br></pre></td></tr></table></div></figure>\n\n<p><strong>nihao.m：</strong></p>\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#import &lt;Foundation/Foundation.h&gt;</span><br><span class=\"line\">int main(int argc, char *argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    @autoreleasepool &#123;</span><br><span class=\"line\">        NSLog(@&quot;nihao!!!&quot;);</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n\n        <h3 id=\"3-2-Clang阶段（Objective-C-C-C-Objective-C-）\"   >\n          <a href=\"#3-2-Clang阶段（Objective-C-C-C-Objective-C-）\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#3-2-Clang阶段（Objective-C-C-C-Objective-C-）\" class=\"headerlink\" title=\"3.2 Clang阶段（Objective-C / C++ / C / Objective-C++）\"></a>3.2 Clang阶段（Objective-C / C++ / C / Objective-C++）</h3>\n      \n        <h4 id=\"预处理阶段：\"   >\n          <a href=\"#预处理阶段：\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#预处理阶段：\" class=\"headerlink\" title=\"预处理阶段：\"></a>预处理阶段：</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -E helloworld.c | open -f</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 1 &quot;nihao.m&quot;</span><br><span class=\"line\"># 1 &quot;&lt;built-in&gt;&quot; 1</span><br><span class=\"line\"># 1 &quot;&lt;built-in&gt;&quot; 3</span><br><span class=\"line\"># 380 &quot;&lt;built-in&gt;&quot; 3</span><br><span class=\"line\"># 1 &quot;&lt;command line&gt;&quot; 1</span><br><span class=\"line\"># 1 &quot;&lt;built-in&gt;&quot; 2</span><br><span class=\"line\"># 1 &quot;nihao.m&quot; 2</span><br><span class=\"line\"># 1 &quot;/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/System/Library/Frameworks/Foundation.framework/Headers/Foundation.h&quot; 1 3</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char *argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    @autoreleasepool &#123;</span><br><span class=\"line\">        NSLog(@&quot;nihao!!!&quot;);</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>将预处理阶段输出到文件， 可以看到很多以 <strong>#</strong> 开头的语句，这些语句告诉我们后面跟着的内容来自哪里，这里可以看见 <strong>Foundation.h</strong> 文件的内容也包含了进来。在 <strong>Xcode</strong> 中，也可以通过 <strong>Product -&gt;  Perfrom Action -&gt; Preprocess</strong> 查看预处理阶段之后的代码。在预处理阶段做了以下这些事情：</p>\n<ul>\n<li>将头文件引入的其他文件加入源文件中，是一个递归的过程。</li>\n<li>进行条件编译处理。</li>\n<li>将宏定义直接替换，不进行语法检查。</li>\n<li>将注释进行删除处理。</li>\n</ul>\n\n        <h4 id=\"词法分析阶段\"   >\n          <a href=\"#词法分析阶段\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#词法分析阶段\" class=\"headerlink\" title=\"词法分析阶段\"></a>词法分析阶段</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -fmodules -fsyntax-only -Xclang -dump-tokens nihao.m</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">annot_module_include &#x27;#import &lt;Foundation/Foundation.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;\t\tLoc=&lt;nihao.m:1:1&gt;</span><br><span class=\"line\">int &#x27;int&#x27;\t [StartOfLine]\tLoc=&lt;nihao.m:3:1&gt;</span><br><span class=\"line\">identifier &#x27;main&#x27;\t [LeadingSpace]\tLoc=&lt;nihao.m:3:5&gt;</span><br><span class=\"line\">l_paren &#x27;(&#x27;\t\tLoc=&lt;nihao.m:3:9&gt;</span><br><span class=\"line\">int &#x27;int&#x27;\t\tLoc=&lt;nihao.m:3:10&gt;</span><br><span class=\"line\">identifier &#x27;argc&#x27;\t [LeadingSpace]\tLoc=&lt;nihao.m:3:14&gt;</span><br><span class=\"line\">comma &#x27;,&#x27;\t\tLoc=&lt;nihao.m:3:18&gt;</span><br><span class=\"line\">char &#x27;char&#x27;\t [LeadingSpace]\tLoc=&lt;nihao.m:3:20&gt;</span><br><span class=\"line\">star &#x27;*&#x27;\t [LeadingSpace]\tLoc=&lt;nihao.m:3:25&gt;</span><br><span class=\"line\">identifier &#x27;argv&#x27;\t\tLoc=&lt;nihao.m:3:26&gt;</span><br><span class=\"line\">l_square &#x27;[&#x27;\t\tLoc=&lt;nihao.m:3:30&gt;</span><br><span class=\"line\">r_square &#x27;]&#x27;\t\tLoc=&lt;nihao.m:3:31&gt;</span><br><span class=\"line\">r_paren &#x27;)&#x27;\t\tLoc=&lt;nihao.m:3:32&gt;</span><br><span class=\"line\">l_brace &#x27;&#123;&#x27;\t [StartOfLine]\tLoc=&lt;nihao.m:4:1&gt;</span><br><span class=\"line\">at &#x27;@&#x27;\t [StartOfLine] [LeadingSpace]\tLoc=&lt;nihao.m:5:5&gt;</span><br><span class=\"line\">identifier &#x27;autoreleasepool&#x27;\t\tLoc=&lt;nihao.m:5:6&gt;</span><br><span class=\"line\">...</span><br></pre></td></tr></table></div></figure>\n\n<p>词法分析阶段其实是将源代码以字符文本的形式转换成 <strong>Token</strong> 流的形式，不涉及语义校验，用来标识出这个字符是标识符、括号、if语句…，最后还会标识出其所在位置，方便后续分析能够找出出错的原始位置。</p>\n\n        <h4 id=\"语法分析阶段\"   >\n          <a href=\"#语法分析阶段\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#语法分析阶段\" class=\"headerlink\" title=\"语法分析阶段\"></a>语法分析阶段</h4>\n      <figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -fsyntax-only -Xclang -ast-dump nihao.m | open -f</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">`-FunctionDecl 0x7f9eb4bd61a0 &lt;nihao.m:3:1, line:9:1&gt; line:3:5 main &#x27;int (int, char **)&#x27;</span><br><span class=\"line\">  |-ParmVarDecl 0x7f9eb4bd5fc0 &lt;col:10, col:14&gt; col:14 argc &#x27;int&#x27;</span><br><span class=\"line\">  |-ParmVarDecl 0x7f9eb4bd6080 &lt;col:20, col:31&gt; col:26 argv &#x27;char **&#x27;:&#x27;char **&#x27;</span><br><span class=\"line\">  `-CompoundStmt 0x7f9eb4bd63d0 &lt;line:4:1, line:9:1&gt;</span><br><span class=\"line\">    `-ObjCAutoreleasePoolStmt 0x7f9eb4bd63b8 &lt;line:5:5, line:8:5&gt;</span><br><span class=\"line\">      `-CompoundStmt 0x7f9eb4bd6398 &lt;line:5:22, line:8:5&gt;</span><br><span class=\"line\">        |-CallExpr 0x7f9eb4bd6328 &lt;line:6:9, col:26&gt; &#x27;void&#x27;</span><br><span class=\"line\">        | |-ImplicitCastExpr 0x7f9eb4bd6310 &lt;col:9&gt; &#x27;void (*)(id, ...)&#x27; &lt;FunctionToPointerDecay&gt;</span><br><span class=\"line\">        | | `-DeclRefExpr 0x7f9eb4bd6250 &lt;col:9&gt; &#x27;void (id, ...)&#x27; Function 0x7f9eb0c8d6c8 &#x27;NSLog&#x27; &#x27;void (id, ...)&#x27;</span><br><span class=\"line\">        | `-ImplicitCastExpr 0x7f9eb4bd6350 &lt;col:15, col:16&gt; &#x27;id&#x27;:&#x27;id&#x27; &lt;BitCast&gt;</span><br><span class=\"line\">        |   `-ObjCStringLiteral 0x7f9eb4bd6290 &lt;col:15, col:16&gt; &#x27;NSString *&#x27;</span><br><span class=\"line\">        |     `-StringLiteral 0x7f9eb4bd6270 &lt;col:16&gt; &#x27;char [9]&#x27; lvalue &quot;nihao!!!&quot;</span><br><span class=\"line\">        `-ReturnStmt 0x7f9eb4bd6388 &lt;line:7:9, col:16&gt;</span><br><span class=\"line\">          `-IntegerLiteral 0x7f9eb4bd6368 &lt;col:16&gt; &#x27;int&#x27; 0</span><br></pre></td></tr></table></div></figure>\n\n<p>语法分析阶段会输出 <strong>AST</strong>（抽象语法树），它是源代码语法结构的一种抽象表示。它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。通过它，可以进行语法错误分析，以及静态分析操作，涵盖内存操作和安全等方面。</p>\n\n        <h4 id=\"CodeGen阶段\"   >\n          <a href=\"#CodeGen阶段\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#CodeGen阶段\" class=\"headerlink\" title=\"CodeGen阶段\"></a>CodeGen阶段</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">; ModuleID = &#x27;nihao.m&#x27;</span><br><span class=\"line\">source_filename = &quot;nihao.m&quot;</span><br><span class=\"line\">target datalayout = &quot;e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class=\"line\">target triple = &quot;x86_64-apple-macosx11.0.0&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">%struct.__NSConstantString_tag = type &#123; i32*, i32, i8*, i64 &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@__CFConstantStringClassReference = external global [0 x i32]</span><br><span class=\"line\">@.str = private unnamed_addr constant [9 x i8] c&quot;nihao!!!\\00&quot;, section &quot;__TEXT,__cstring,cstring_literals&quot;, align 1</span><br><span class=\"line\">@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag &#123; i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 &#125;, section &quot;__DATA,__cfstring&quot;, align 8 #0</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: noinline optnone ssp uwtable</span><br><span class=\"line\">define i32 @main(i32 %0, i8** %1) #1 &#123;</span><br><span class=\"line\">  %3 = alloca i32, align 4</span><br><span class=\"line\">  %4 = alloca i32, align 4</span><br><span class=\"line\">  %5 = alloca i8**, align 8</span><br><span class=\"line\">  store i32 0, i32* %3, align 4</span><br><span class=\"line\">  store i32 %0, i32* %4, align 4</span><br><span class=\"line\">  store i8** %1, i8*** %5, align 8</span><br><span class=\"line\">  %6 = call i8* @llvm.objc.autoreleasePoolPush() #2</span><br><span class=\"line\">  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*))</span><br><span class=\"line\">  store i32 0, i32* %3, align 4</span><br><span class=\"line\">  call void @llvm.objc.autoreleasePoolPop(i8* %6)</span><br><span class=\"line\">  %7 = load i32, i32* %3, align 4</span><br><span class=\"line\">  ret i32 %7</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: nounwind</span><br><span class=\"line\">declare i8* @llvm.objc.autoreleasePoolPush() #2</span><br><span class=\"line\"></span><br><span class=\"line\">declare void @NSLog(i8*, ...) #3</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: nounwind</span><br><span class=\"line\">declare void @llvm.objc.autoreleasePoolPop(i8*) #2</span><br><span class=\"line\"></span><br><span class=\"line\">attributes #0 = &#123; &quot;objc_arc_inert&quot; &#125;</span><br><span class=\"line\">attributes #1 = &#123; noinline optnone ssp uwtable &quot;darwin-stkchk-strong-link&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;probe-stack&quot;=&quot;___chkstk_darwin&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;penryn&quot; &quot;target-features&quot;=&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class=\"line\">attributes #2 = &#123; nounwind &#125;</span><br><span class=\"line\">attributes #3 = &#123; &quot;darwin-stkchk-strong-link&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;probe-stack&quot;=&quot;___chkstk_darwin&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;penryn&quot; &quot;target-features&quot;=&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">!llvm.module.flags = !&#123;!0, !1, !2, !3, !4, !5, !6, !7&#125;</span><br><span class=\"line\">!llvm.ident = !&#123;!8&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">!0 = !&#123;i32 2, !&quot;SDK Version&quot;, [2 x i32] [i32 12, i32 0]&#125;</span><br><span class=\"line\">!1 = !&#123;i32 1, !&quot;Objective-C Version&quot;, i32 2&#125;</span><br><span class=\"line\">!2 = !&#123;i32 1, !&quot;Objective-C Image Info Version&quot;, i32 0&#125;</span><br><span class=\"line\">!3 = !&#123;i32 1, !&quot;Objective-C Image Info Section&quot;, !&quot;__DATA,__objc_imageinfo,regular,no_dead_strip&quot;&#125;</span><br><span class=\"line\">!4 = !&#123;i32 1, !&quot;Objective-C Garbage Collection&quot;, i8 0&#125;</span><br><span class=\"line\">!5 = !&#123;i32 1, !&quot;Objective-C Class Properties&quot;, i32 64&#125;</span><br><span class=\"line\">!6 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class=\"line\">!7 = !&#123;i32 7, !&quot;PIC Level&quot;, i32 2&#125;</span><br><span class=\"line\">!8 = !&#123;!&quot;Apple clang version 13.0.0 (clang-1300.0.29.3)&quot;&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p><strong>CodeGen</strong> 阶段负责将 <strong>AST</strong> 自顶向下遍历逐步翻译成 <strong>LLVM IR</strong>，也就是编译器后端所需要的中间代码，同时 <strong>Objective-C</strong> 代码也会在这一步进行 <strong>Runtime</strong> 桥接： <strong>property</strong> 合成，<strong>ARC</strong> 处理等，如上方可以看见 <strong>autoreleasePoolPush</strong> 、 <strong>autoreleasePoolPop</strong> 操作。</p>\n<p>至此 <strong>Clang</strong> 前端工作算是完成，接下来就交给后端进行处理。</p>\n\n        <h3 id=\"3-3-LLVM-Optimizer-阶段\"   >\n          <a href=\"#3-3-LLVM-Optimizer-阶段\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#3-3-LLVM-Optimizer-阶段\" class=\"headerlink\" title=\"3.3 LLVM Optimizer 阶段\"></a>3.3 LLVM Optimizer 阶段</h3>\n      \n        <h4 id=\"IR代码优化\"   >\n          <a href=\"#IR代码优化\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#IR代码优化\" class=\"headerlink\" title=\"IR代码优化\"></a>IR代码优化</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -Os -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">; ModuleID = &#x27;nihao.m&#x27;</span><br><span class=\"line\">source_filename = &quot;nihao.m&quot;</span><br><span class=\"line\">target datalayout = &quot;e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class=\"line\">target triple = &quot;x86_64-apple-macosx11.0.0&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">%struct.__NSConstantString_tag = type &#123; i32*, i32, i8*, i64 &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@__CFConstantStringClassReference = external global [0 x i32]</span><br><span class=\"line\">@.str = private unnamed_addr constant [9 x i8] c&quot;nihao!!!\\00&quot;, section &quot;__TEXT,__cstring,cstring_literals&quot;, align 1</span><br><span class=\"line\">@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag &#123; i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 &#125;, section &quot;__DATA,__cfstring&quot;, align 8 #0</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: optsize ssp uwtable</span><br><span class=\"line\">define i32 @main(i32 %0, i8** nocapture readnone %1) local_unnamed_addr #1 &#123;</span><br><span class=\"line\">  %3 = tail call i8* @llvm.objc.autoreleasePoolPush() #2</span><br><span class=\"line\">  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*)) #4, !clang.arc.no_objc_arc_exceptions !9</span><br><span class=\"line\">  tail call void @llvm.objc.autoreleasePoolPop(i8* %3) #2</span><br><span class=\"line\">  ret i32 0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: nounwind</span><br><span class=\"line\">declare i8* @llvm.objc.autoreleasePoolPush() #2</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: optsize</span><br><span class=\"line\">declare void @NSLog(i8*, ...) local_unnamed_addr #3</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: nounwind</span><br><span class=\"line\">declare void @llvm.objc.autoreleasePoolPop(i8*) #2</span><br><span class=\"line\"></span><br><span class=\"line\">attributes #0 = &#123; &quot;objc_arc_inert&quot; &#125;</span><br><span class=\"line\">attributes #1 = &#123; optsize ssp uwtable &quot;darwin-stkchk-strong-link&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;probe-stack&quot;=&quot;___chkstk_darwin&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;penryn&quot; &quot;target-features&quot;=&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class=\"line\">attributes #2 = &#123; nounwind &#125;</span><br><span class=\"line\">attributes #3 = &#123; optsize &quot;darwin-stkchk-strong-link&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;probe-stack&quot;=&quot;___chkstk_darwin&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;penryn&quot; &quot;target-features&quot;=&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class=\"line\">attributes #4 = &#123; optsize &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">!llvm.module.flags = !&#123;!0, !1, !2, !3, !4, !5, !6, !7&#125;</span><br><span class=\"line\">!llvm.ident = !&#123;!8&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">!0 = !&#123;i32 2, !&quot;SDK Version&quot;, [2 x i32] [i32 12, i32 0]&#125;</span><br><span class=\"line\">!1 = !&#123;i32 1, !&quot;Objective-C Version&quot;, i32 2&#125;</span><br><span class=\"line\">!2 = !&#123;i32 1, !&quot;Objective-C Image Info Version&quot;, i32 0&#125;</span><br><span class=\"line\">!3 = !&#123;i32 1, !&quot;Objective-C Image Info Section&quot;, !&quot;__DATA,__objc_imageinfo,regular,no_dead_strip&quot;&#125;</span><br><span class=\"line\">!4 = !&#123;i32 1, !&quot;Objective-C Garbage Collection&quot;, i8 0&#125;</span><br><span class=\"line\">!5 = !&#123;i32 1, !&quot;Objective-C Class Properties&quot;, i32 64&#125;</span><br><span class=\"line\">!6 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class=\"line\">!7 = !&#123;i32 7, !&quot;PIC Level&quot;, i32 2&#125;</span><br><span class=\"line\">!8 = !&#123;!&quot;Apple clang version 13.0.0 (clang-1300.0.29.3)&quot;&#125;</span><br><span class=\"line\">!9 = !&#123;&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p><strong>IR</strong> 代码优化会调用相应 <strong>Pass</strong> 进行处理，<strong>Pass</strong> 由多个节点组成，都是 <strong>Pass</strong> 类的子类，每个节点负责特定的优化。这使得我们能够自主的控制优化的强度，在<strong>Build Strrings -&gt; Optimization Level</strong> 中可指定优化程度，一些常见的代码优化方法如下：</p>\n<ul>\n<li>删除公共子表达式</li>\n<li>删除无用代码</li>\n<li>常量合并</li>\n<li>代码移动</li>\n<li>删除归纳变量</li>\n</ul>\n\n        <h4 id=\"生成-BitCode（Archive时）\"   >\n          <a href=\"#生成-BitCode（Archive时）\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#生成-BitCode（Archive时）\" class=\"headerlink\" title=\"生成 BitCode（Archive时）\"></a>生成 BitCode（Archive时）</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xrun clang -emit-llvm -c nihao.m -o nihao.bc</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dec0 170b 0000 0000 1400 0000 0010 0000</span><br><span class=\"line\">0700 0001 4243 c0de 3514 0000 0700 0000</span><br><span class=\"line\">620c 3024 9596 a6a5 f7d7 7f7d d3b4 4ffb</span><br><span class=\"line\">76ef df3f 2d44 0132 0500 0000 210c 0000</span><br><span class=\"line\">4903 0000 0b02 2100 0200 0000 1600 0000</span><br><span class=\"line\">0781 2391 41c8 0449 0610 3239 9201 840c</span><br><span class=\"line\">2505 0819 1e04 8b62 8014 4502 4292 0b42</span><br><span class=\"line\">a410 3214 3808 184b 0a32 5288 4870 c421</span><br><span class=\"line\">...</span><br></pre></td></tr></table></div></figure>\n\n<p><strong>BitCode</strong> 是 <strong>LLVM</strong> 引入的另一种中间代码，虽然看起来比较接近机器码，但是在函数和指令层面使用了很多高级语言的特性。</p>\n<p>但只会在 <strong>Archive</strong> 时，<strong>BitCode</strong> 才会被嵌入到链接后的二进制文件，用于提交给 <strong>App Store</strong>，包含 <strong>Bitcode</strong> 配置的程序将会在 <strong>App Store</strong> 上被重新编译和链接，进而对可执行文件做优化。值得注意的是，优化这一步是在 <strong>App Store</strong> 中做的处理，本地没有做处理。进行其他类型的 <strong>Build</strong> (非 <strong>Archive</strong> )时，编译器只会检查是否满足开启 <strong>BitCode</strong> 的条件，但并不会真正生成 <strong>BitCode</strong> 。</p>\n\n        <h3 id=\"3-4-LLVM-Code-Generator阶段\"   >\n          <a href=\"#3-4-LLVM-Code-Generator阶段\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#3-4-LLVM-Code-Generator阶段\" class=\"headerlink\" title=\"3.4 LLVM Code Generator阶段\"></a>3.4 LLVM Code Generator阶段</h3>\n      \n        <h4 id=\"生成汇编代码\"   >\n          <a href=\"#生成汇编代码\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#生成汇编代码\" class=\"headerlink\" title=\"生成汇编代码\"></a>生成汇编代码</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -S -fobjc-arc nihao.m -o nihao.s</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\t.section\t__TEXT,__text,regular,pure_instructions</span><br><span class=\"line\">\t.build_version macos, 11, 0\tsdk_version 12, 0</span><br><span class=\"line\">\t.globl\t_main                           ## -- Begin function main</span><br><span class=\"line\">\t.p2align\t4, 0x90</span><br><span class=\"line\">_main:                                  ## @main</span><br><span class=\"line\">\t.cfi_startproc</span><br><span class=\"line\">## %bb.0:</span><br><span class=\"line\">\tpushq\t%rbp</span><br><span class=\"line\">\t.cfi_def_cfa_offset 16</span><br><span class=\"line\">\t.cfi_offset %rbp, -16</span><br><span class=\"line\">\tmovq\t%rsp, %rbp</span><br><span class=\"line\">\t.cfi_def_cfa_register %rbp</span><br><span class=\"line\">\tsubq\t$32, %rsp</span><br><span class=\"line\">\tmovl\t$0, -4(%rbp)</span><br><span class=\"line\">\tmovl\t%edi, -8(%rbp)</span><br><span class=\"line\">\tmovq\t%rsi, -16(%rbp)</span><br><span class=\"line\">\tcallq\t_objc_autoreleasePoolPush</span><br><span class=\"line\">\tmovq\t%rax, -24(%rbp)                 ## 8-byte Spill</span><br><span class=\"line\">\tleaq\tL__unnamed_cfstring_(%rip), %rdi</span><br><span class=\"line\">\tmovb\t$0, %al</span><br><span class=\"line\">\tcallq\t_NSLog</span><br><span class=\"line\">\tmovq\t-24(%rbp), %rdi                 ## 8-byte Reload</span><br><span class=\"line\">\tmovl\t$0, -4(%rbp)</span><br><span class=\"line\">\tcallq\t_objc_autoreleasePoolPop</span><br><span class=\"line\">\tmovl\t-4(%rbp), %eax</span><br><span class=\"line\">\taddq\t$32, %rsp</span><br><span class=\"line\">\tpopq\t%rbp</span><br><span class=\"line\">\tretq</span><br><span class=\"line\">\t.cfi_endproc</span><br><span class=\"line\">                                        ## -- End function</span><br><span class=\"line\">\t.section\t__TEXT,__cstring,cstring_literals</span><br><span class=\"line\">L_.str:                                 ## @.str</span><br><span class=\"line\">\t.asciz\t&quot;nihao!!!&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\t.section\t__DATA,__cfstring</span><br><span class=\"line\">\t.p2align\t3                               ## @_unnamed_cfstring_</span><br><span class=\"line\">L__unnamed_cfstring_:</span><br><span class=\"line\">\t.quad\t___CFConstantStringClassReference</span><br><span class=\"line\">\t.long\t1992                            ## 0x7c8</span><br><span class=\"line\">\t.space\t4</span><br><span class=\"line\">\t.quad\tL_.str</span><br><span class=\"line\">\t.quad\t8                               ## 0x8</span><br><span class=\"line\"></span><br><span class=\"line\">\t.section\t__DATA,__objc_imageinfo,regular,no_dead_strip</span><br><span class=\"line\">L_OBJC_IMAGE_INFO:</span><br><span class=\"line\">\t.long\t0</span><br><span class=\"line\">\t.long\t64</span><br><span class=\"line\"></span><br><span class=\"line\">.subsections_via_symbols</span><br></pre></td></tr></table></div></figure>\n\n<p>汇编语言更加接近机器语言，能够直接对硬件进行操作，生成的程序与其他的语言相比具有更高的运行速度，占用更小的内存。</p>\n<p>目前所有 <strong>iOS</strong> 设备都采用 <strong>ARM</strong> 处理器，这意味着都是采用 <strong>ARM</strong> 指令集，如 <strong>armv6 / armv7 / armv7s / arm64</strong>，这些指令集都是向下兼容的。</p>\n<p>每种 <strong>CPU</strong> 架构都有着相应的指令集，可以针对不同的架构产生不同的汇编指令，加上上面 <strong>- arch arch_type</strong> 选项即可，更多请参见<span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://developer.apple.com/library/archive/documentation/DeveloperTools/Reference/Assembler/000-Introduction/introduction.html\" >官网</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span>。在 <strong>Xcode</strong> 中可在 <strong>Build Settings -&gt; Architectrues</strong> 指定产生的 <strong>CPU</strong> 指令集。</p>\n\n        <h4 id=\"生成机器代码\"   >\n          <a href=\"#生成机器代码\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#生成机器代码\" class=\"headerlink\" title=\"生成机器代码\"></a>生成机器代码</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -fmodules -c nihao.s -o nihao.o</span><br></pre></td></tr></table></div></figure>\n\n<p>可以发现机器码二进制文件无法阅读，可借助 <strong>otool</strong> 或者 <strong>MachOView</strong> 等工具查看文件中的相关内容：</p>\n<figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">otool -v -h nihao.o</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nihao.o:</span><br><span class=\"line\">Mach header</span><br><span class=\"line\">      magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</span><br><span class=\"line\">MH_MAGIC_64   X86_64        ALL  0x00      OBJECT     4        680 SUBSECTIONS_VIA_SYMBOLS</span><br></pre></td></tr></table></div></figure>\n\n<p>可以看见 <strong>.o</strong> 文件实际上是 <strong>mach-o</strong> 格式，这里我们输入可执行文件的头部，规定了这个文件是什么，适应架构的相关信息，以及文件是如何被加载的。更多关于 <strong>mach-o</strong> 的知识<span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.jianshu.com/p/54d842db3f69\" >参见</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span>。</p>\n\n        <h4 id=\"链接\"   >\n          <a href=\"#链接\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#链接\" class=\"headerlink\" title=\"链接\"></a>链接</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang nihao.o -Wl,`xcrun --show-sdk-path`/System/Library/Frameworks/Foundation.framework/Foundation</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./a.out</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2021-11-03 16:06:41.734 a.out[6394:220026] nihao!!!</span><br></pre></td></tr></table></div></figure>\n\n<p>由于我们引入了 <strong>Foundation</strong> 里面的文件，所以需要将目标文件和 <strong>Foundation framework</strong>进行链接，接着就可以运行我们的程序了。</p>\n<p>这里涉及到一个概念：符号表，里面存储的元素如下：</p>\n<figure class=\"highlight xml\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;起始地址&gt; &lt;结束地址&gt; &lt;函数&gt; [&lt;文件名:行号&gt;]</span><br></pre></td></tr></table></div></figure>\n\n<p>这里我们输入a.out的符号信息</p>\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nm -nm a.out</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">                 (undefined) external _NSLog (from Foundation)</span><br><span class=\"line\">                 (undefined) external ___CFConstantStringClassReference (from CoreFoundation)</span><br><span class=\"line\">                 (undefined) external _objc_autoreleasePoolPop (from libobjc)</span><br><span class=\"line\">                 (undefined) external _objc_autoreleasePoolPush (from libobjc)</span><br><span class=\"line\">                 (undefined) external dyld_stub_binder (from libSystem)</span><br><span class=\"line\">0000000100000000 (__TEXT,__text) [referenced dynamically] external __mh_execute_header</span><br><span class=\"line\">0000000100003f20 (__TEXT,__text) external _main</span><br><span class=\"line\">0000000100008018 (__DATA,__data) non-external __dyld_private</span><br></pre></td></tr></table></div></figure>\n\n<p>对于动态链接库的符号（如 <strong>Foundation</strong>），最终会记录下这个符号是通过进行链接的，并记录下依赖于哪个动态链接库。在运行时，动态链接器（<strong>dyld</strong>）会去解析这些 <strong>undefined</strong> 符号。对于其他位置的符号，会直接修正这些符号的具体位置信息。</p>\n\n        <h2 id=\"4-总结\"   >\n          <a href=\"#4-总结\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#4-总结\" class=\"headerlink\" title=\"4. 总结\"></a>4. 总结</h2>\n      <p>本文介绍了关于 iOS 编译器、iOS 编译过程的基础知识。学习了这些，对 iOS 编译有个整体认识。就本人而言，在一路搜寻资料的过程中，对之前一些零散的知识点有了一些更加深入的认识。由于篇幅有限，关于 SwiftC 的编译过程没有多做介绍，后面会再出一篇进行介绍。</p>\n<p>🔗：</p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://objccn.io/issue-6-3/\" >ObjC 中国 - Mach-O 可执行文件</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://kiprey.github.io/2020/06/LLVM-IR-pass/\" >代码优化与LLVM IR pass</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"http://xelz.info/blog/2018/11/24/all-you-need-to-know-about-bitcode/\" >关于bitcode, 知道这些就够了</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://zhuanlan.zhihu.com/p/340782811\" >iOS 编译链接：Objective-C 编译链接</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.jianshu.com/p/54d842db3f69\" >趣探 Mach-O：文件格式分析</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n","site":{"data":{}},"excerpt":"","more":"\n        <h1 id=\"iOS-编译过程\"   >\n          <a href=\"#iOS-编译过程\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#iOS-编译过程\" class=\"headerlink\" title=\"iOS 编译过程\"></a>iOS 编译过程</h1>\n      \n        <h2 id=\"1-前言\"   >\n          <a href=\"#1-前言\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#1-前言\" class=\"headerlink\" title=\"1. 前言\"></a>1. 前言</h2>\n      <p>学习 <strong>iOS</strong> 编译过程（<strong>Compile</strong>）有助于我们更好理解代码是如何被计算机运作起来，编译器为代码做了哪些优化，让我们学会从另一个角度来看待问题。</p>\n\n        <h2 id=\"2-编译器结构\"   >\n          <a href=\"#2-编译器结构\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#2-编译器结构\" class=\"headerlink\" title=\"2. 编译器结构\"></a>2. 编译器结构</h2>\n      <p>现代编译器是将源代码转换成可执行文件的程序，工作流程主要分为 <strong>前端</strong> 和 <strong>后端</strong> 两个部分：</p>\n<ol>\n<li>前端：对源代码进行解析，并生成中间代码。</li>\n<li>后端：针对中间代码进行优化，并转换成目标机器的代码指令。</li>\n</ol>\n<pre class=\"mermaid\">graph LR\n    A(SourceCode) --> B(Frontend)\n    B(Frontend) --> C(Backend)\n    C(Backend) --> D(Machine Code)</pre>\n\n<p>针对iOS平台，不同语言采用了不同的编译器前端：</p>\n<ol>\n<li><p><strong>Frontend：Clang / SwiftC</strong></p>\n<p>对于 <strong>Objective-C / C / C++ / Objective-C++</strong>  来说采用 <strong>Clang</strong> 编译器前端；</p>\n<p>对于 <strong>Swift</strong> 来说则采用 <strong>SwiftC</strong>；</p>\n</li>\n<li><p><strong>Backend：LLVM</strong></p>\n<p>无论是 <strong>C</strong> 系语言还是 <strong>Swift</strong> 都采用 <strong>LLVM</strong> 作为编译器后端；</p>\n</li>\n</ol>\n<p>值得注意的是在 <strong>Xcode3</strong> 以前，都采用 <strong>GCC</strong> 作为编译器前端，但为 <strong>Apple</strong> 快速发展需要功能更强大和性能更好的编译器，所以 <strong>Apple</strong> 自己开发了 <strong>Clang</strong> 作为编译器前端。下面对编译器做一个简要介绍：</p>\n<ul>\n<li><strong>GCC</strong></li>\n</ul>\n<p><strong>GCC</strong>（<strong>GNU Compile Collection</strong>，**GNU **编译器套装），是一套由 <strong>GNU</strong> 开发的编程语言编译器。来本只能处理 <em>C</em> 语言，后来快速演进，变得可处理 <strong>C++、Objective-C、Java、Fortran</strong> 等其他语言。但由于一些缺陷，导致了 <strong>Apple</strong> 抛弃了 <strong>GCC</strong> ，开发出了 <strong>Clang</strong> 作为其前端编译器。</p>\n<ol>\n<li><strong>GCC</strong> 的 <strong>Objective-C Frontend</strong> 不是 <strong>Apple</strong> 维护，导致想要添加一些语法提示等功能得去要求 <strong>GCC</strong> 团队做。</li>\n<li><strong>GCC</strong> 的插件、工具、<strong>IDE</strong> 的支持薄弱。</li>\n<li><strong>GCC</strong> 的编译效率和性能不足。</li>\n</ol>\n<ul>\n<li><strong>Clang</strong></li>\n</ul>\n<p><strong>Clang1.0</strong> 于 <strong>2009</strong> 年正式与 <strong>LLVM2.6</strong> 正式发布，旨在提供 <strong>GCC</strong> 的替代品，支持了 <strong>GUN</strong> 编译器大多数的编译器设置以及非官方语言的拓展，相较于 <strong>GCC</strong> ，<strong>Clang</strong> 具有以下优势：</p>\n<ol>\n<li>编译速度更快。</li>\n<li>占用内存更小。</li>\n<li>模块化设计，易于拓展与重用。</li>\n<li>诊断信息可读性强。</li>\n</ol>\n<ul>\n<li><strong>SwiftC</strong></li>\n</ul>\n<p><strong>SwiftC</strong> 在前端采用了 <strong>SIL</strong> 中间语言，这是因为 <strong>Swift</strong> 作为一种高级语言，有许多特性，如 <strong>protocol</strong> 的泛型，也是一门安全的语言，确保变量在使用之前被初始化、检测不可执行的代码，于是增加了一层 <strong>SIL</strong> 来做这些事情。</p>\n<ul>\n<li><strong>LLVM</strong></li>\n</ul>\n<p><strong>LLVM</strong> 是一套编译器基础设备项目，由 <strong>C++</strong> 写成，包含一系列模块化的编译器组件和工具链，用来开发编译器的前端和后端。在 <strong>iOS</strong> 中，<strong>LLVM</strong> 作为编译器后端主要提供 <strong>Optimizer</strong> 和 <strong>Code Generator</strong> ，将接收到的 <strong>IR</strong> 中间代码进行优化，以及机器代码生成。</p>\n\n        <h2 id=\"3-编译过程\"   >\n          <a href=\"#3-编译过程\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#3-编译过程\" class=\"headerlink\" title=\"3. 编译过程\"></a>3. 编译过程</h2>\n      \n        <h3 id=\"3-1-流程梳理\"   >\n          <a href=\"#3-1-流程梳理\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#3-1-流程梳理\" class=\"headerlink\" title=\"3.1 流程梳理\"></a>3.1 流程梳理</h3>\n      <pre class=\"mermaid\">graph TD\n    subgraph Clang\n    id1(源代码) --> id2(预处理) \n    id2(预处理) --> id3(语法分析)   \n    id3(语法分析) --  token  --> id4(语法分析)\n    id4(语法分析) --  AST  --> id5(中间代码生成)\n    end\n    \n    subgraph Optimizer, Backend\n    id6(中间代码优化) --> id7(BitCode生成)\n    id7(BitCode生成) --> id8(汇编指令生成)\n    id8(汇编指令生成) --> id9(机器码生成)\n    id9(机器码生成) --> id11(链接生成可执行文件)\n    end\n    \n    subgraph SwiftC\n    id12(源代码) --> id13(解析)\n    id13(解析) --> id14(语义分析)\n    id14(语义分析) --> id15(Clang导入器)\n    id15(Clang导入器) --> id16(SIL生成)\n    id16(SIL生成) --> id17(SIL保证转换)\n    id17 --> id18(SIL优化)\n    id18(SIL优化) --> id19(中间代码生成)\n    end\n    \n    id5 --  IR  --> id6\n    id19 --  IR  --> id6</pre>\n\n<p>在前端 <strong>Objective-C</strong> 和 <strong>Swift</strong> 分别由自己的处理阶段，但最后都会生成 <strong>IR</strong> 中间代码，交由后端进行统一处理。</p>\n<p>下面我们从一个简单的.m文件进行编译过程梳理，首先在某一个目录下创建一个 <strong>nihao.m</strong>文件</p>\n<figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">touch nihao.m</span><br></pre></td></tr></table></div></figure>\n\n<p><strong>nihao.m：</strong></p>\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#import &lt;Foundation/Foundation.h&gt;</span><br><span class=\"line\">int main(int argc, char *argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    @autoreleasepool &#123;</span><br><span class=\"line\">        NSLog(@&quot;nihao!!!&quot;);</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n\n        <h3 id=\"3-2-Clang阶段（Objective-C-C-C-Objective-C-）\"   >\n          <a href=\"#3-2-Clang阶段（Objective-C-C-C-Objective-C-）\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#3-2-Clang阶段（Objective-C-C-C-Objective-C-）\" class=\"headerlink\" title=\"3.2 Clang阶段（Objective-C / C++ / C / Objective-C++）\"></a>3.2 Clang阶段（Objective-C / C++ / C / Objective-C++）</h3>\n      \n        <h4 id=\"预处理阶段：\"   >\n          <a href=\"#预处理阶段：\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#预处理阶段：\" class=\"headerlink\" title=\"预处理阶段：\"></a>预处理阶段：</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -E helloworld.c | open -f</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 1 &quot;nihao.m&quot;</span><br><span class=\"line\"># 1 &quot;&lt;built-in&gt;&quot; 1</span><br><span class=\"line\"># 1 &quot;&lt;built-in&gt;&quot; 3</span><br><span class=\"line\"># 380 &quot;&lt;built-in&gt;&quot; 3</span><br><span class=\"line\"># 1 &quot;&lt;command line&gt;&quot; 1</span><br><span class=\"line\"># 1 &quot;&lt;built-in&gt;&quot; 2</span><br><span class=\"line\"># 1 &quot;nihao.m&quot; 2</span><br><span class=\"line\"># 1 &quot;/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/System/Library/Frameworks/Foundation.framework/Headers/Foundation.h&quot; 1 3</span><br><span class=\"line\"></span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char *argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    @autoreleasepool &#123;</span><br><span class=\"line\">        NSLog(@&quot;nihao!!!&quot;);</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>将预处理阶段输出到文件， 可以看到很多以 <strong>#</strong> 开头的语句，这些语句告诉我们后面跟着的内容来自哪里，这里可以看见 <strong>Foundation.h</strong> 文件的内容也包含了进来。在 <strong>Xcode</strong> 中，也可以通过 <strong>Product -&gt;  Perfrom Action -&gt; Preprocess</strong> 查看预处理阶段之后的代码。在预处理阶段做了以下这些事情：</p>\n<ul>\n<li>将头文件引入的其他文件加入源文件中，是一个递归的过程。</li>\n<li>进行条件编译处理。</li>\n<li>将宏定义直接替换，不进行语法检查。</li>\n<li>将注释进行删除处理。</li>\n</ul>\n\n        <h4 id=\"词法分析阶段\"   >\n          <a href=\"#词法分析阶段\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#词法分析阶段\" class=\"headerlink\" title=\"词法分析阶段\"></a>词法分析阶段</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -fmodules -fsyntax-only -Xclang -dump-tokens nihao.m</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">annot_module_include &#x27;#import &lt;Foundation/Foundation.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;\t\tLoc=&lt;nihao.m:1:1&gt;</span><br><span class=\"line\">int &#x27;int&#x27;\t [StartOfLine]\tLoc=&lt;nihao.m:3:1&gt;</span><br><span class=\"line\">identifier &#x27;main&#x27;\t [LeadingSpace]\tLoc=&lt;nihao.m:3:5&gt;</span><br><span class=\"line\">l_paren &#x27;(&#x27;\t\tLoc=&lt;nihao.m:3:9&gt;</span><br><span class=\"line\">int &#x27;int&#x27;\t\tLoc=&lt;nihao.m:3:10&gt;</span><br><span class=\"line\">identifier &#x27;argc&#x27;\t [LeadingSpace]\tLoc=&lt;nihao.m:3:14&gt;</span><br><span class=\"line\">comma &#x27;,&#x27;\t\tLoc=&lt;nihao.m:3:18&gt;</span><br><span class=\"line\">char &#x27;char&#x27;\t [LeadingSpace]\tLoc=&lt;nihao.m:3:20&gt;</span><br><span class=\"line\">star &#x27;*&#x27;\t [LeadingSpace]\tLoc=&lt;nihao.m:3:25&gt;</span><br><span class=\"line\">identifier &#x27;argv&#x27;\t\tLoc=&lt;nihao.m:3:26&gt;</span><br><span class=\"line\">l_square &#x27;[&#x27;\t\tLoc=&lt;nihao.m:3:30&gt;</span><br><span class=\"line\">r_square &#x27;]&#x27;\t\tLoc=&lt;nihao.m:3:31&gt;</span><br><span class=\"line\">r_paren &#x27;)&#x27;\t\tLoc=&lt;nihao.m:3:32&gt;</span><br><span class=\"line\">l_brace &#x27;&#123;&#x27;\t [StartOfLine]\tLoc=&lt;nihao.m:4:1&gt;</span><br><span class=\"line\">at &#x27;@&#x27;\t [StartOfLine] [LeadingSpace]\tLoc=&lt;nihao.m:5:5&gt;</span><br><span class=\"line\">identifier &#x27;autoreleasepool&#x27;\t\tLoc=&lt;nihao.m:5:6&gt;</span><br><span class=\"line\">...</span><br></pre></td></tr></table></div></figure>\n\n<p>词法分析阶段其实是将源代码以字符文本的形式转换成 <strong>Token</strong> 流的形式，不涉及语义校验，用来标识出这个字符是标识符、括号、if语句…，最后还会标识出其所在位置，方便后续分析能够找出出错的原始位置。</p>\n\n        <h4 id=\"语法分析阶段\"   >\n          <a href=\"#语法分析阶段\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#语法分析阶段\" class=\"headerlink\" title=\"语法分析阶段\"></a>语法分析阶段</h4>\n      <figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -fsyntax-only -Xclang -ast-dump nihao.m | open -f</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">`-FunctionDecl 0x7f9eb4bd61a0 &lt;nihao.m:3:1, line:9:1&gt; line:3:5 main &#x27;int (int, char **)&#x27;</span><br><span class=\"line\">  |-ParmVarDecl 0x7f9eb4bd5fc0 &lt;col:10, col:14&gt; col:14 argc &#x27;int&#x27;</span><br><span class=\"line\">  |-ParmVarDecl 0x7f9eb4bd6080 &lt;col:20, col:31&gt; col:26 argv &#x27;char **&#x27;:&#x27;char **&#x27;</span><br><span class=\"line\">  `-CompoundStmt 0x7f9eb4bd63d0 &lt;line:4:1, line:9:1&gt;</span><br><span class=\"line\">    `-ObjCAutoreleasePoolStmt 0x7f9eb4bd63b8 &lt;line:5:5, line:8:5&gt;</span><br><span class=\"line\">      `-CompoundStmt 0x7f9eb4bd6398 &lt;line:5:22, line:8:5&gt;</span><br><span class=\"line\">        |-CallExpr 0x7f9eb4bd6328 &lt;line:6:9, col:26&gt; &#x27;void&#x27;</span><br><span class=\"line\">        | |-ImplicitCastExpr 0x7f9eb4bd6310 &lt;col:9&gt; &#x27;void (*)(id, ...)&#x27; &lt;FunctionToPointerDecay&gt;</span><br><span class=\"line\">        | | `-DeclRefExpr 0x7f9eb4bd6250 &lt;col:9&gt; &#x27;void (id, ...)&#x27; Function 0x7f9eb0c8d6c8 &#x27;NSLog&#x27; &#x27;void (id, ...)&#x27;</span><br><span class=\"line\">        | `-ImplicitCastExpr 0x7f9eb4bd6350 &lt;col:15, col:16&gt; &#x27;id&#x27;:&#x27;id&#x27; &lt;BitCast&gt;</span><br><span class=\"line\">        |   `-ObjCStringLiteral 0x7f9eb4bd6290 &lt;col:15, col:16&gt; &#x27;NSString *&#x27;</span><br><span class=\"line\">        |     `-StringLiteral 0x7f9eb4bd6270 &lt;col:16&gt; &#x27;char [9]&#x27; lvalue &quot;nihao!!!&quot;</span><br><span class=\"line\">        `-ReturnStmt 0x7f9eb4bd6388 &lt;line:7:9, col:16&gt;</span><br><span class=\"line\">          `-IntegerLiteral 0x7f9eb4bd6368 &lt;col:16&gt; &#x27;int&#x27; 0</span><br></pre></td></tr></table></div></figure>\n\n<p>语法分析阶段会输出 <strong>AST</strong>（抽象语法树），它是源代码语法结构的一种抽象表示。它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。通过它，可以进行语法错误分析，以及静态分析操作，涵盖内存操作和安全等方面。</p>\n\n        <h4 id=\"CodeGen阶段\"   >\n          <a href=\"#CodeGen阶段\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#CodeGen阶段\" class=\"headerlink\" title=\"CodeGen阶段\"></a>CodeGen阶段</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">; ModuleID = &#x27;nihao.m&#x27;</span><br><span class=\"line\">source_filename = &quot;nihao.m&quot;</span><br><span class=\"line\">target datalayout = &quot;e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class=\"line\">target triple = &quot;x86_64-apple-macosx11.0.0&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">%struct.__NSConstantString_tag = type &#123; i32*, i32, i8*, i64 &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@__CFConstantStringClassReference = external global [0 x i32]</span><br><span class=\"line\">@.str = private unnamed_addr constant [9 x i8] c&quot;nihao!!!\\00&quot;, section &quot;__TEXT,__cstring,cstring_literals&quot;, align 1</span><br><span class=\"line\">@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag &#123; i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 &#125;, section &quot;__DATA,__cfstring&quot;, align 8 #0</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: noinline optnone ssp uwtable</span><br><span class=\"line\">define i32 @main(i32 %0, i8** %1) #1 &#123;</span><br><span class=\"line\">  %3 = alloca i32, align 4</span><br><span class=\"line\">  %4 = alloca i32, align 4</span><br><span class=\"line\">  %5 = alloca i8**, align 8</span><br><span class=\"line\">  store i32 0, i32* %3, align 4</span><br><span class=\"line\">  store i32 %0, i32* %4, align 4</span><br><span class=\"line\">  store i8** %1, i8*** %5, align 8</span><br><span class=\"line\">  %6 = call i8* @llvm.objc.autoreleasePoolPush() #2</span><br><span class=\"line\">  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*))</span><br><span class=\"line\">  store i32 0, i32* %3, align 4</span><br><span class=\"line\">  call void @llvm.objc.autoreleasePoolPop(i8* %6)</span><br><span class=\"line\">  %7 = load i32, i32* %3, align 4</span><br><span class=\"line\">  ret i32 %7</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: nounwind</span><br><span class=\"line\">declare i8* @llvm.objc.autoreleasePoolPush() #2</span><br><span class=\"line\"></span><br><span class=\"line\">declare void @NSLog(i8*, ...) #3</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: nounwind</span><br><span class=\"line\">declare void @llvm.objc.autoreleasePoolPop(i8*) #2</span><br><span class=\"line\"></span><br><span class=\"line\">attributes #0 = &#123; &quot;objc_arc_inert&quot; &#125;</span><br><span class=\"line\">attributes #1 = &#123; noinline optnone ssp uwtable &quot;darwin-stkchk-strong-link&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;probe-stack&quot;=&quot;___chkstk_darwin&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;penryn&quot; &quot;target-features&quot;=&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class=\"line\">attributes #2 = &#123; nounwind &#125;</span><br><span class=\"line\">attributes #3 = &#123; &quot;darwin-stkchk-strong-link&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;probe-stack&quot;=&quot;___chkstk_darwin&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;penryn&quot; &quot;target-features&quot;=&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">!llvm.module.flags = !&#123;!0, !1, !2, !3, !4, !5, !6, !7&#125;</span><br><span class=\"line\">!llvm.ident = !&#123;!8&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">!0 = !&#123;i32 2, !&quot;SDK Version&quot;, [2 x i32] [i32 12, i32 0]&#125;</span><br><span class=\"line\">!1 = !&#123;i32 1, !&quot;Objective-C Version&quot;, i32 2&#125;</span><br><span class=\"line\">!2 = !&#123;i32 1, !&quot;Objective-C Image Info Version&quot;, i32 0&#125;</span><br><span class=\"line\">!3 = !&#123;i32 1, !&quot;Objective-C Image Info Section&quot;, !&quot;__DATA,__objc_imageinfo,regular,no_dead_strip&quot;&#125;</span><br><span class=\"line\">!4 = !&#123;i32 1, !&quot;Objective-C Garbage Collection&quot;, i8 0&#125;</span><br><span class=\"line\">!5 = !&#123;i32 1, !&quot;Objective-C Class Properties&quot;, i32 64&#125;</span><br><span class=\"line\">!6 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class=\"line\">!7 = !&#123;i32 7, !&quot;PIC Level&quot;, i32 2&#125;</span><br><span class=\"line\">!8 = !&#123;!&quot;Apple clang version 13.0.0 (clang-1300.0.29.3)&quot;&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p><strong>CodeGen</strong> 阶段负责将 <strong>AST</strong> 自顶向下遍历逐步翻译成 <strong>LLVM IR</strong>，也就是编译器后端所需要的中间代码，同时 <strong>Objective-C</strong> 代码也会在这一步进行 <strong>Runtime</strong> 桥接： <strong>property</strong> 合成，<strong>ARC</strong> 处理等，如上方可以看见 <strong>autoreleasePoolPush</strong> 、 <strong>autoreleasePoolPop</strong> 操作。</p>\n<p>至此 <strong>Clang</strong> 前端工作算是完成，接下来就交给后端进行处理。</p>\n\n        <h3 id=\"3-3-LLVM-Optimizer-阶段\"   >\n          <a href=\"#3-3-LLVM-Optimizer-阶段\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#3-3-LLVM-Optimizer-阶段\" class=\"headerlink\" title=\"3.3 LLVM Optimizer 阶段\"></a>3.3 LLVM Optimizer 阶段</h3>\n      \n        <h4 id=\"IR代码优化\"   >\n          <a href=\"#IR代码优化\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#IR代码优化\" class=\"headerlink\" title=\"IR代码优化\"></a>IR代码优化</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -Os -S -fobjc-arc -emit-llvm nihao.m -o nihao.ll</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">; ModuleID = &#x27;nihao.m&#x27;</span><br><span class=\"line\">source_filename = &quot;nihao.m&quot;</span><br><span class=\"line\">target datalayout = &quot;e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class=\"line\">target triple = &quot;x86_64-apple-macosx11.0.0&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">%struct.__NSConstantString_tag = type &#123; i32*, i32, i8*, i64 &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@__CFConstantStringClassReference = external global [0 x i32]</span><br><span class=\"line\">@.str = private unnamed_addr constant [9 x i8] c&quot;nihao!!!\\00&quot;, section &quot;__TEXT,__cstring,cstring_literals&quot;, align 1</span><br><span class=\"line\">@_unnamed_cfstring_ = private global %struct.__NSConstantString_tag &#123; i32* getelementptr inbounds ([0 x i32], [0 x i32]* @__CFConstantStringClassReference, i32 0, i32 0), i32 1992, i8* getelementptr inbounds ([9 x i8], [9 x i8]* @.str, i32 0, i32 0), i64 8 &#125;, section &quot;__DATA,__cfstring&quot;, align 8 #0</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: optsize ssp uwtable</span><br><span class=\"line\">define i32 @main(i32 %0, i8** nocapture readnone %1) local_unnamed_addr #1 &#123;</span><br><span class=\"line\">  %3 = tail call i8* @llvm.objc.autoreleasePoolPush() #2</span><br><span class=\"line\">  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*)) #4, !clang.arc.no_objc_arc_exceptions !9</span><br><span class=\"line\">  tail call void @llvm.objc.autoreleasePoolPop(i8* %3) #2</span><br><span class=\"line\">  ret i32 0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: nounwind</span><br><span class=\"line\">declare i8* @llvm.objc.autoreleasePoolPush() #2</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: optsize</span><br><span class=\"line\">declare void @NSLog(i8*, ...) local_unnamed_addr #3</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: nounwind</span><br><span class=\"line\">declare void @llvm.objc.autoreleasePoolPop(i8*) #2</span><br><span class=\"line\"></span><br><span class=\"line\">attributes #0 = &#123; &quot;objc_arc_inert&quot; &#125;</span><br><span class=\"line\">attributes #1 = &#123; optsize ssp uwtable &quot;darwin-stkchk-strong-link&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;probe-stack&quot;=&quot;___chkstk_darwin&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;penryn&quot; &quot;target-features&quot;=&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class=\"line\">attributes #2 = &#123; nounwind &#125;</span><br><span class=\"line\">attributes #3 = &#123; optsize &quot;darwin-stkchk-strong-link&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;probe-stack&quot;=&quot;___chkstk_darwin&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;penryn&quot; &quot;target-features&quot;=&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class=\"line\">attributes #4 = &#123; optsize &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">!llvm.module.flags = !&#123;!0, !1, !2, !3, !4, !5, !6, !7&#125;</span><br><span class=\"line\">!llvm.ident = !&#123;!8&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">!0 = !&#123;i32 2, !&quot;SDK Version&quot;, [2 x i32] [i32 12, i32 0]&#125;</span><br><span class=\"line\">!1 = !&#123;i32 1, !&quot;Objective-C Version&quot;, i32 2&#125;</span><br><span class=\"line\">!2 = !&#123;i32 1, !&quot;Objective-C Image Info Version&quot;, i32 0&#125;</span><br><span class=\"line\">!3 = !&#123;i32 1, !&quot;Objective-C Image Info Section&quot;, !&quot;__DATA,__objc_imageinfo,regular,no_dead_strip&quot;&#125;</span><br><span class=\"line\">!4 = !&#123;i32 1, !&quot;Objective-C Garbage Collection&quot;, i8 0&#125;</span><br><span class=\"line\">!5 = !&#123;i32 1, !&quot;Objective-C Class Properties&quot;, i32 64&#125;</span><br><span class=\"line\">!6 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class=\"line\">!7 = !&#123;i32 7, !&quot;PIC Level&quot;, i32 2&#125;</span><br><span class=\"line\">!8 = !&#123;!&quot;Apple clang version 13.0.0 (clang-1300.0.29.3)&quot;&#125;</span><br><span class=\"line\">!9 = !&#123;&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p><strong>IR</strong> 代码优化会调用相应 <strong>Pass</strong> 进行处理，<strong>Pass</strong> 由多个节点组成，都是 <strong>Pass</strong> 类的子类，每个节点负责特定的优化。这使得我们能够自主的控制优化的强度，在<strong>Build Strrings -&gt; Optimization Level</strong> 中可指定优化程度，一些常见的代码优化方法如下：</p>\n<ul>\n<li>删除公共子表达式</li>\n<li>删除无用代码</li>\n<li>常量合并</li>\n<li>代码移动</li>\n<li>删除归纳变量</li>\n</ul>\n\n        <h4 id=\"生成-BitCode（Archive时）\"   >\n          <a href=\"#生成-BitCode（Archive时）\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#生成-BitCode（Archive时）\" class=\"headerlink\" title=\"生成 BitCode（Archive时）\"></a>生成 BitCode（Archive时）</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xrun clang -emit-llvm -c nihao.m -o nihao.bc</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dec0 170b 0000 0000 1400 0000 0010 0000</span><br><span class=\"line\">0700 0001 4243 c0de 3514 0000 0700 0000</span><br><span class=\"line\">620c 3024 9596 a6a5 f7d7 7f7d d3b4 4ffb</span><br><span class=\"line\">76ef df3f 2d44 0132 0500 0000 210c 0000</span><br><span class=\"line\">4903 0000 0b02 2100 0200 0000 1600 0000</span><br><span class=\"line\">0781 2391 41c8 0449 0610 3239 9201 840c</span><br><span class=\"line\">2505 0819 1e04 8b62 8014 4502 4292 0b42</span><br><span class=\"line\">a410 3214 3808 184b 0a32 5288 4870 c421</span><br><span class=\"line\">...</span><br></pre></td></tr></table></div></figure>\n\n<p><strong>BitCode</strong> 是 <strong>LLVM</strong> 引入的另一种中间代码，虽然看起来比较接近机器码，但是在函数和指令层面使用了很多高级语言的特性。</p>\n<p>但只会在 <strong>Archive</strong> 时，<strong>BitCode</strong> 才会被嵌入到链接后的二进制文件，用于提交给 <strong>App Store</strong>，包含 <strong>Bitcode</strong> 配置的程序将会在 <strong>App Store</strong> 上被重新编译和链接，进而对可执行文件做优化。值得注意的是，优化这一步是在 <strong>App Store</strong> 中做的处理，本地没有做处理。进行其他类型的 <strong>Build</strong> (非 <strong>Archive</strong> )时，编译器只会检查是否满足开启 <strong>BitCode</strong> 的条件，但并不会真正生成 <strong>BitCode</strong> 。</p>\n\n        <h3 id=\"3-4-LLVM-Code-Generator阶段\"   >\n          <a href=\"#3-4-LLVM-Code-Generator阶段\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#3-4-LLVM-Code-Generator阶段\" class=\"headerlink\" title=\"3.4 LLVM Code Generator阶段\"></a>3.4 LLVM Code Generator阶段</h3>\n      \n        <h4 id=\"生成汇编代码\"   >\n          <a href=\"#生成汇编代码\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#生成汇编代码\" class=\"headerlink\" title=\"生成汇编代码\"></a>生成汇编代码</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -S -fobjc-arc nihao.m -o nihao.s</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\t.section\t__TEXT,__text,regular,pure_instructions</span><br><span class=\"line\">\t.build_version macos, 11, 0\tsdk_version 12, 0</span><br><span class=\"line\">\t.globl\t_main                           ## -- Begin function main</span><br><span class=\"line\">\t.p2align\t4, 0x90</span><br><span class=\"line\">_main:                                  ## @main</span><br><span class=\"line\">\t.cfi_startproc</span><br><span class=\"line\">## %bb.0:</span><br><span class=\"line\">\tpushq\t%rbp</span><br><span class=\"line\">\t.cfi_def_cfa_offset 16</span><br><span class=\"line\">\t.cfi_offset %rbp, -16</span><br><span class=\"line\">\tmovq\t%rsp, %rbp</span><br><span class=\"line\">\t.cfi_def_cfa_register %rbp</span><br><span class=\"line\">\tsubq\t$32, %rsp</span><br><span class=\"line\">\tmovl\t$0, -4(%rbp)</span><br><span class=\"line\">\tmovl\t%edi, -8(%rbp)</span><br><span class=\"line\">\tmovq\t%rsi, -16(%rbp)</span><br><span class=\"line\">\tcallq\t_objc_autoreleasePoolPush</span><br><span class=\"line\">\tmovq\t%rax, -24(%rbp)                 ## 8-byte Spill</span><br><span class=\"line\">\tleaq\tL__unnamed_cfstring_(%rip), %rdi</span><br><span class=\"line\">\tmovb\t$0, %al</span><br><span class=\"line\">\tcallq\t_NSLog</span><br><span class=\"line\">\tmovq\t-24(%rbp), %rdi                 ## 8-byte Reload</span><br><span class=\"line\">\tmovl\t$0, -4(%rbp)</span><br><span class=\"line\">\tcallq\t_objc_autoreleasePoolPop</span><br><span class=\"line\">\tmovl\t-4(%rbp), %eax</span><br><span class=\"line\">\taddq\t$32, %rsp</span><br><span class=\"line\">\tpopq\t%rbp</span><br><span class=\"line\">\tretq</span><br><span class=\"line\">\t.cfi_endproc</span><br><span class=\"line\">                                        ## -- End function</span><br><span class=\"line\">\t.section\t__TEXT,__cstring,cstring_literals</span><br><span class=\"line\">L_.str:                                 ## @.str</span><br><span class=\"line\">\t.asciz\t&quot;nihao!!!&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\t.section\t__DATA,__cfstring</span><br><span class=\"line\">\t.p2align\t3                               ## @_unnamed_cfstring_</span><br><span class=\"line\">L__unnamed_cfstring_:</span><br><span class=\"line\">\t.quad\t___CFConstantStringClassReference</span><br><span class=\"line\">\t.long\t1992                            ## 0x7c8</span><br><span class=\"line\">\t.space\t4</span><br><span class=\"line\">\t.quad\tL_.str</span><br><span class=\"line\">\t.quad\t8                               ## 0x8</span><br><span class=\"line\"></span><br><span class=\"line\">\t.section\t__DATA,__objc_imageinfo,regular,no_dead_strip</span><br><span class=\"line\">L_OBJC_IMAGE_INFO:</span><br><span class=\"line\">\t.long\t0</span><br><span class=\"line\">\t.long\t64</span><br><span class=\"line\"></span><br><span class=\"line\">.subsections_via_symbols</span><br></pre></td></tr></table></div></figure>\n\n<p>汇编语言更加接近机器语言，能够直接对硬件进行操作，生成的程序与其他的语言相比具有更高的运行速度，占用更小的内存。</p>\n<p>目前所有 <strong>iOS</strong> 设备都采用 <strong>ARM</strong> 处理器，这意味着都是采用 <strong>ARM</strong> 指令集，如 <strong>armv6 / armv7 / armv7s / arm64</strong>，这些指令集都是向下兼容的。</p>\n<p>每种 <strong>CPU</strong> 架构都有着相应的指令集，可以针对不同的架构产生不同的汇编指令，加上上面 <strong>- arch arch_type</strong> 选项即可，更多请参见<span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://developer.apple.com/library/archive/documentation/DeveloperTools/Reference/Assembler/000-Introduction/introduction.html\" >官网</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span>。在 <strong>Xcode</strong> 中可在 <strong>Build Settings -&gt; Architectrues</strong> 指定产生的 <strong>CPU</strong> 指令集。</p>\n\n        <h4 id=\"生成机器代码\"   >\n          <a href=\"#生成机器代码\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#生成机器代码\" class=\"headerlink\" title=\"生成机器代码\"></a>生成机器代码</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang -fmodules -c nihao.s -o nihao.o</span><br></pre></td></tr></table></div></figure>\n\n<p>可以发现机器码二进制文件无法阅读，可借助 <strong>otool</strong> 或者 <strong>MachOView</strong> 等工具查看文件中的相关内容：</p>\n<figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">otool -v -h nihao.o</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nihao.o:</span><br><span class=\"line\">Mach header</span><br><span class=\"line\">      magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</span><br><span class=\"line\">MH_MAGIC_64   X86_64        ALL  0x00      OBJECT     4        680 SUBSECTIONS_VIA_SYMBOLS</span><br></pre></td></tr></table></div></figure>\n\n<p>可以看见 <strong>.o</strong> 文件实际上是 <strong>mach-o</strong> 格式，这里我们输入可执行文件的头部，规定了这个文件是什么，适应架构的相关信息，以及文件是如何被加载的。更多关于 <strong>mach-o</strong> 的知识<span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.jianshu.com/p/54d842db3f69\" >参见</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span>。</p>\n\n        <h4 id=\"链接\"   >\n          <a href=\"#链接\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#链接\" class=\"headerlink\" title=\"链接\"></a>链接</h4>\n      <figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xcrun clang nihao.o -Wl,`xcrun --show-sdk-path`/System/Library/Frameworks/Foundation.framework/Foundation</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight shell\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./a.out</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2021-11-03 16:06:41.734 a.out[6394:220026] nihao!!!</span><br></pre></td></tr></table></div></figure>\n\n<p>由于我们引入了 <strong>Foundation</strong> 里面的文件，所以需要将目标文件和 <strong>Foundation framework</strong>进行链接，接着就可以运行我们的程序了。</p>\n<p>这里涉及到一个概念：符号表，里面存储的元素如下：</p>\n<figure class=\"highlight xml\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;起始地址&gt; &lt;结束地址&gt; &lt;函数&gt; [&lt;文件名:行号&gt;]</span><br></pre></td></tr></table></div></figure>\n\n<p>这里我们输入a.out的符号信息</p>\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nm -nm a.out</span><br></pre></td></tr></table></div></figure>\n\n<figure class=\"highlight plaintext\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">                 (undefined) external _NSLog (from Foundation)</span><br><span class=\"line\">                 (undefined) external ___CFConstantStringClassReference (from CoreFoundation)</span><br><span class=\"line\">                 (undefined) external _objc_autoreleasePoolPop (from libobjc)</span><br><span class=\"line\">                 (undefined) external _objc_autoreleasePoolPush (from libobjc)</span><br><span class=\"line\">                 (undefined) external dyld_stub_binder (from libSystem)</span><br><span class=\"line\">0000000100000000 (__TEXT,__text) [referenced dynamically] external __mh_execute_header</span><br><span class=\"line\">0000000100003f20 (__TEXT,__text) external _main</span><br><span class=\"line\">0000000100008018 (__DATA,__data) non-external __dyld_private</span><br></pre></td></tr></table></div></figure>\n\n<p>对于动态链接库的符号（如 <strong>Foundation</strong>），最终会记录下这个符号是通过进行链接的，并记录下依赖于哪个动态链接库。在运行时，动态链接器（<strong>dyld</strong>）会去解析这些 <strong>undefined</strong> 符号。对于其他位置的符号，会直接修正这些符号的具体位置信息。</p>\n\n        <h2 id=\"4-总结\"   >\n          <a href=\"#4-总结\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#4-总结\" class=\"headerlink\" title=\"4. 总结\"></a>4. 总结</h2>\n      <p>本文介绍了关于 iOS 编译器、iOS 编译过程的基础知识。学习了这些，对 iOS 编译有个整体认识。就本人而言，在一路搜寻资料的过程中，对之前一些零散的知识点有了一些更加深入的认识。由于篇幅有限，关于 SwiftC 的编译过程没有多做介绍，后面会再出一篇进行介绍。</p>\n<p>🔗：</p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://objccn.io/issue-6-3/\" >ObjC 中国 - Mach-O 可执行文件</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://kiprey.github.io/2020/06/LLVM-IR-pass/\" >代码优化与LLVM IR pass</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"http://xelz.info/blog/2018/11/24/all-you-need-to-know-about-bitcode/\" >关于bitcode, 知道这些就够了</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://zhuanlan.zhihu.com/p/340782811\" >iOS 编译链接：Objective-C 编译链接</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.jianshu.com/p/54d842db3f69\" >趣探 Mach-O：文件格式分析</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n"},{"title":"NSTimer循环引用分析与解决","_content":"\n### 前言\n\n本文将从如何使用 **NSTimer** 、 **NSTimer** 何种情况下会造成循环引用，以及如何避免循环引用几个角度进行介绍。\n\n### NSTimer 如何使用\n\n> A timer that fires after a certain time interval has elapsed, sending a specified message to a target object.\n>\n> 翻译：一种计时器，在经过一定的时间间隔后触发，向目标对象发送指定的消息。\n\n#### 创建\n\n**NSTimer** 提供了三种创建方式：\n\n1. 以 `scheduledTimerWithTimeInterval` 类方法开头的创建实例\n\n2. 以 `timerWithTimeInterval` 开头的创建实例\n\n3. 以 `init` 方法初始化方法创建实例\n\n若采用第一种方式创建，会以 **default mode** 方式自动加入到当前的 **RunLoop** 中。\n\n若采用第二、三种方式创建，需手动调用NSRunLoop对象的 `addTimer:forMode:` 方法。\n\n```swift\nlet timer = Timer.init(timeInterval: 1.0, repeats: true) { timer in\n   print(\"This\")\n}\nRunLoop.main.add(timer, forMode: .default)\n```\n\n#### 销毁\n\n`invalidate()` \n\n该方法是在其加入的 **RunLoop** 对象中移除timer的唯一方法，同时会 **RunLoop** 对象会移除其对对象的强引用，若配置了 **target** 和 **user info** 对象， **timer** 也会移除对这些对象的强引用。\n\n### 为何会造成循环引用\n\n#### 循环引用\n\n考虑一个常见使用 **NSTimer** 的场景：在 **ViewController** 中将 **timer** 作为属性，而 **timer** 在创建采用了 **target-action** 的方式，根据 **Apple** 文档，**timer** 会对 **target** 产生强引用，这就产生了有向环，导致循环引用，下图是上例对象引用图：\n\n<img src=\"/assets/2021-09-29-NSTimer 循环引用分析与解决/image-20210817112104936.png\" alt=\"image-20210817112104936\" style=\"zoom:40%;\" />\n\n#### RunLoop持有timer\n\n还是上例的场景，若在 **timer** 创建时不采用 **target-action** ，是不是就可以解决了？\n\n确实可以解决，但还存在一个问题，由于 **RunLoop** 对象还持有着 **timer** 对象，这时 **ViewController** 能被正常释放，但 **timer** 的引用计数由于不为 **1** ，无法被释放，这种情况只是 **timer** 无法被释放，并不算循环引用范畴，当然若 **RunLoop** 对象被释放了，则这个 **timer** 也会被释放掉。\n\n\n\n<img src=\"/assets/2021-09-29-NSTimer 循环引用分析与解决/image-20210817145841853.png\" alt=\"image-20210817145841853\" style=\"zoom:40%;\" />\n\n当然此上两种情况都是将 **timer** 的 `repeat` 参数设置为 `true` 时，若为 `false` 则在定时器第一次触发后，会自动失效，即 **RunLoop** 会移除对 **timer** 的强引用， **timer** 也会移除对 **target** 和 **user info** 对象的强引用。\n\n### 解决方案\n\n#### 合适的时机调用 `invalidate()`\n\n在上文介绍了`invalidate()` ， 我们只需要在合适的时机调用 `invalidate()`即可。\n\n那么什么是合适的时机呢？\n\n1. 若清楚知道什么时候 **timer** 不再使用，则应立即调用。\n2. 若不清楚则应破除循环引用，最后在 **ViewController** 的 `deinit` 中进行调用。\n\n#### 针对循环引用，需破除有向环\n\n1. 采用 `weak` 关键字修饰 **timer** ，但需采用`scheduledTimerWithTimeInterval` 类方法开头的创建实例，因为这个方法会将 **timer** 加入到 **RunLoop** 对象中，否则由于 `weak` 修饰， **timer** 会被自动设为`nil`。\n2. 采用 `weak` 关键字修饰 **target** 对象，但需在 **block** 中进行使用，原理大概是 **block** 中的 **weakSelf** 相当于一个临时变量，进而阻止了循环引用。\n3. 采用中介者模式，让其他对象承担 `target` 角色，从而阻止循环引用。\n4. 基于 **NSProxy** 方式，与 **3** 类似，通过其他对象来阻止循环引用，需注意的是 **NSProxy** 无法直接使用。\n5. 也可直接使用 **Apple** 提供的新 **API**：\n\n```swift\nclass func scheduledTimer(withTimeInterval interval: TimeInterval, repeats: Bool, block: @escaping (Timer) -> Void) -> Timer\n\ninit(timeInterval interval: TimeInterval, repeats: Bool, block: @escaping (Timer) -> Void)\n\nconvenience init(fire date: Date, interval: TimeInterval, repeats: Bool, block: @escaping (Timer) -> Void)\n```\n\n\n\n> the timer itself is passed as the parameter to this block when executed to aid in avoiding cyclical references。\n>\n> 翻译：在执行时，定时器本身作为参数传递给这个块，以帮助避免循环引用。\n\n### 引用\n\n[iOS之NSTimer循环引用的解决方案](https://juejin.cn/post/6844903968250789896#heading-5)\n\n[iOS中Timer循环引用原因及解决方案](https://www.jianshu.com/p/e8fc6c2b3afa)\n\n[Apple文档 - NSTimer](https://developer.apple.com/documentation/foundation/nstimer/)\n\n","source":"_posts/2021-09-29-NSTimer 循环引用分析与解决.md","raw":"---\ntitle: \"NSTimer循环引用分析与解决\"\ncategories:\n  - iOS\ntags:\n  - NSTimer\n  - iOS\n---\n\n### 前言\n\n本文将从如何使用 **NSTimer** 、 **NSTimer** 何种情况下会造成循环引用，以及如何避免循环引用几个角度进行介绍。\n\n### NSTimer 如何使用\n\n> A timer that fires after a certain time interval has elapsed, sending a specified message to a target object.\n>\n> 翻译：一种计时器，在经过一定的时间间隔后触发，向目标对象发送指定的消息。\n\n#### 创建\n\n**NSTimer** 提供了三种创建方式：\n\n1. 以 `scheduledTimerWithTimeInterval` 类方法开头的创建实例\n\n2. 以 `timerWithTimeInterval` 开头的创建实例\n\n3. 以 `init` 方法初始化方法创建实例\n\n若采用第一种方式创建，会以 **default mode** 方式自动加入到当前的 **RunLoop** 中。\n\n若采用第二、三种方式创建，需手动调用NSRunLoop对象的 `addTimer:forMode:` 方法。\n\n```swift\nlet timer = Timer.init(timeInterval: 1.0, repeats: true) { timer in\n   print(\"This\")\n}\nRunLoop.main.add(timer, forMode: .default)\n```\n\n#### 销毁\n\n`invalidate()` \n\n该方法是在其加入的 **RunLoop** 对象中移除timer的唯一方法，同时会 **RunLoop** 对象会移除其对对象的强引用，若配置了 **target** 和 **user info** 对象， **timer** 也会移除对这些对象的强引用。\n\n### 为何会造成循环引用\n\n#### 循环引用\n\n考虑一个常见使用 **NSTimer** 的场景：在 **ViewController** 中将 **timer** 作为属性，而 **timer** 在创建采用了 **target-action** 的方式，根据 **Apple** 文档，**timer** 会对 **target** 产生强引用，这就产生了有向环，导致循环引用，下图是上例对象引用图：\n\n<img src=\"/assets/2021-09-29-NSTimer 循环引用分析与解决/image-20210817112104936.png\" alt=\"image-20210817112104936\" style=\"zoom:40%;\" />\n\n#### RunLoop持有timer\n\n还是上例的场景，若在 **timer** 创建时不采用 **target-action** ，是不是就可以解决了？\n\n确实可以解决，但还存在一个问题，由于 **RunLoop** 对象还持有着 **timer** 对象，这时 **ViewController** 能被正常释放，但 **timer** 的引用计数由于不为 **1** ，无法被释放，这种情况只是 **timer** 无法被释放，并不算循环引用范畴，当然若 **RunLoop** 对象被释放了，则这个 **timer** 也会被释放掉。\n\n\n\n<img src=\"/assets/2021-09-29-NSTimer 循环引用分析与解决/image-20210817145841853.png\" alt=\"image-20210817145841853\" style=\"zoom:40%;\" />\n\n当然此上两种情况都是将 **timer** 的 `repeat` 参数设置为 `true` 时，若为 `false` 则在定时器第一次触发后，会自动失效，即 **RunLoop** 会移除对 **timer** 的强引用， **timer** 也会移除对 **target** 和 **user info** 对象的强引用。\n\n### 解决方案\n\n#### 合适的时机调用 `invalidate()`\n\n在上文介绍了`invalidate()` ， 我们只需要在合适的时机调用 `invalidate()`即可。\n\n那么什么是合适的时机呢？\n\n1. 若清楚知道什么时候 **timer** 不再使用，则应立即调用。\n2. 若不清楚则应破除循环引用，最后在 **ViewController** 的 `deinit` 中进行调用。\n\n#### 针对循环引用，需破除有向环\n\n1. 采用 `weak` 关键字修饰 **timer** ，但需采用`scheduledTimerWithTimeInterval` 类方法开头的创建实例，因为这个方法会将 **timer** 加入到 **RunLoop** 对象中，否则由于 `weak` 修饰， **timer** 会被自动设为`nil`。\n2. 采用 `weak` 关键字修饰 **target** 对象，但需在 **block** 中进行使用，原理大概是 **block** 中的 **weakSelf** 相当于一个临时变量，进而阻止了循环引用。\n3. 采用中介者模式，让其他对象承担 `target` 角色，从而阻止循环引用。\n4. 基于 **NSProxy** 方式，与 **3** 类似，通过其他对象来阻止循环引用，需注意的是 **NSProxy** 无法直接使用。\n5. 也可直接使用 **Apple** 提供的新 **API**：\n\n```swift\nclass func scheduledTimer(withTimeInterval interval: TimeInterval, repeats: Bool, block: @escaping (Timer) -> Void) -> Timer\n\ninit(timeInterval interval: TimeInterval, repeats: Bool, block: @escaping (Timer) -> Void)\n\nconvenience init(fire date: Date, interval: TimeInterval, repeats: Bool, block: @escaping (Timer) -> Void)\n```\n\n\n\n> the timer itself is passed as the parameter to this block when executed to aid in avoiding cyclical references。\n>\n> 翻译：在执行时，定时器本身作为参数传递给这个块，以帮助避免循环引用。\n\n### 引用\n\n[iOS之NSTimer循环引用的解决方案](https://juejin.cn/post/6844903968250789896#heading-5)\n\n[iOS中Timer循环引用原因及解决方案](https://www.jianshu.com/p/e8fc6c2b3afa)\n\n[Apple文档 - NSTimer](https://developer.apple.com/documentation/foundation/nstimer/)\n\n","slug":"2021-09-29-NSTimer 循环引用分析与解决","published":1,"date":"2021-09-29T08:14:33.312Z","updated":"2021-09-30T06:04:28.614Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckvko2j2n0009qezuccskefx3","content":"\n        <h3 id=\"前言\"   >\n          <a href=\"#前言\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3>\n      <p>本文将从如何使用 <strong>NSTimer</strong> 、 <strong>NSTimer</strong> 何种情况下会造成循环引用，以及如何避免循环引用几个角度进行介绍。</p>\n\n        <h3 id=\"NSTimer-如何使用\"   >\n          <a href=\"#NSTimer-如何使用\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#NSTimer-如何使用\" class=\"headerlink\" title=\"NSTimer 如何使用\"></a>NSTimer 如何使用</h3>\n      <blockquote>\n<p>A timer that fires after a certain time interval has elapsed, sending a specified message to a target object.</p>\n<p>翻译：一种计时器，在经过一定的时间间隔后触发，向目标对象发送指定的消息。</p>\n</blockquote>\n\n        <h4 id=\"创建\"   >\n          <a href=\"#创建\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#创建\" class=\"headerlink\" title=\"创建\"></a>创建</h4>\n      <p><strong>NSTimer</strong> 提供了三种创建方式：</p>\n<ol>\n<li><p>以 <code>scheduledTimerWithTimeInterval</code> 类方法开头的创建实例</p>\n</li>\n<li><p>以 <code>timerWithTimeInterval</code> 开头的创建实例</p>\n</li>\n<li><p>以 <code>init</code> 方法初始化方法创建实例</p>\n</li>\n</ol>\n<p>若采用第一种方式创建，会以 <strong>default mode</strong> 方式自动加入到当前的 <strong>RunLoop</strong> 中。</p>\n<p>若采用第二、三种方式创建，需手动调用NSRunLoop对象的 <code>addTimer:forMode:</code> 方法。</p>\n<figure class=\"highlight swift\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> timer <span class=\"operator\">=</span> <span class=\"type\">Timer</span>.<span class=\"keyword\">init</span>(timeInterval: <span class=\"number\">1.0</span>, repeats: <span class=\"literal\">true</span>) &#123; timer <span class=\"keyword\">in</span></span><br><span class=\"line\">   <span class=\"built_in\">print</span>(<span class=\"string\">&quot;This&quot;</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">RunLoop</span>.main.add(timer, forMode: .default)</span><br></pre></td></tr></table></div></figure>\n\n\n        <h4 id=\"销毁\"   >\n          <a href=\"#销毁\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#销毁\" class=\"headerlink\" title=\"销毁\"></a>销毁</h4>\n      <p><code>invalidate()</code> </p>\n<p>该方法是在其加入的 <strong>RunLoop</strong> 对象中移除timer的唯一方法，同时会 <strong>RunLoop</strong> 对象会移除其对对象的强引用，若配置了 <strong>target</strong> 和 <strong>user info</strong> 对象， <strong>timer</strong> 也会移除对这些对象的强引用。</p>\n\n        <h3 id=\"为何会造成循环引用\"   >\n          <a href=\"#为何会造成循环引用\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#为何会造成循环引用\" class=\"headerlink\" title=\"为何会造成循环引用\"></a>为何会造成循环引用</h3>\n      \n        <h4 id=\"循环引用\"   >\n          <a href=\"#循环引用\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#循环引用\" class=\"headerlink\" title=\"循环引用\"></a>循环引用</h4>\n      <p>考虑一个常见使用 <strong>NSTimer</strong> 的场景：在 <strong>ViewController</strong> 中将 <strong>timer</strong> 作为属性，而 <strong>timer</strong> 在创建采用了 <strong>target-action</strong> 的方式，根据 <strong>Apple</strong> 文档，<strong>timer</strong> 会对 <strong>target</strong> 产生强引用，这就产生了有向环，导致循环引用，下图是上例对象引用图：</p>\n<img src=\"/assets/2021-09-29-NSTimer 循环引用分析与解决/image-20210817112104936.png\" alt=\"image-20210817112104936\" style=\"zoom:40%;\" />\n\n\n        <h4 id=\"RunLoop持有timer\"   >\n          <a href=\"#RunLoop持有timer\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#RunLoop持有timer\" class=\"headerlink\" title=\"RunLoop持有timer\"></a>RunLoop持有timer</h4>\n      <p>还是上例的场景，若在 <strong>timer</strong> 创建时不采用 <strong>target-action</strong> ，是不是就可以解决了？</p>\n<p>确实可以解决，但还存在一个问题，由于 <strong>RunLoop</strong> 对象还持有着 <strong>timer</strong> 对象，这时 <strong>ViewController</strong> 能被正常释放，但 <strong>timer</strong> 的引用计数由于不为 <strong>1</strong> ，无法被释放，这种情况只是 <strong>timer</strong> 无法被释放，并不算循环引用范畴，当然若 <strong>RunLoop</strong> 对象被释放了，则这个 <strong>timer</strong> 也会被释放掉。</p>\n<img src=\"/assets/2021-09-29-NSTimer 循环引用分析与解决/image-20210817145841853.png\" alt=\"image-20210817145841853\" style=\"zoom:40%;\" />\n\n<p>当然此上两种情况都是将 <strong>timer</strong> 的 <code>repeat</code> 参数设置为 <code>true</code> 时，若为 <code>false</code> 则在定时器第一次触发后，会自动失效，即 <strong>RunLoop</strong> 会移除对 <strong>timer</strong> 的强引用， <strong>timer</strong> 也会移除对 <strong>target</strong> 和 <strong>user info</strong> 对象的强引用。</p>\n\n        <h3 id=\"解决方案\"   >\n          <a href=\"#解决方案\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h3>\n      \n        <h4 id=\"合适的时机调用-invalidate\"   >\n          <a href=\"#合适的时机调用-invalidate\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#合适的时机调用-invalidate\" class=\"headerlink\" title=\"合适的时机调用 invalidate()\"></a>合适的时机调用 <code>invalidate()</code></h4>\n      <p>在上文介绍了<code>invalidate()</code> ， 我们只需要在合适的时机调用 <code>invalidate()</code>即可。</p>\n<p>那么什么是合适的时机呢？</p>\n<ol>\n<li>若清楚知道什么时候 <strong>timer</strong> 不再使用，则应立即调用。</li>\n<li>若不清楚则应破除循环引用，最后在 <strong>ViewController</strong> 的 <code>deinit</code> 中进行调用。</li>\n</ol>\n\n        <h4 id=\"针对循环引用，需破除有向环\"   >\n          <a href=\"#针对循环引用，需破除有向环\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#针对循环引用，需破除有向环\" class=\"headerlink\" title=\"针对循环引用，需破除有向环\"></a>针对循环引用，需破除有向环</h4>\n      <ol>\n<li>采用 <code>weak</code> 关键字修饰 <strong>timer</strong> ，但需采用<code>scheduledTimerWithTimeInterval</code> 类方法开头的创建实例，因为这个方法会将 <strong>timer</strong> 加入到 <strong>RunLoop</strong> 对象中，否则由于 <code>weak</code> 修饰， <strong>timer</strong> 会被自动设为<code>nil</code>。</li>\n<li>采用 <code>weak</code> 关键字修饰 <strong>target</strong> 对象，但需在 <strong>block</strong> 中进行使用，原理大概是 <strong>block</strong> 中的 <strong>weakSelf</strong> 相当于一个临时变量，进而阻止了循环引用。</li>\n<li>采用中介者模式，让其他对象承担 <code>target</code> 角色，从而阻止循环引用。</li>\n<li>基于 <strong>NSProxy</strong> 方式，与 <strong>3</strong> 类似，通过其他对象来阻止循环引用，需注意的是 <strong>NSProxy</strong> 无法直接使用。</li>\n<li>也可直接使用 <strong>Apple</strong> 提供的新 <strong>API</strong>：</li>\n</ol>\n<figure class=\"highlight swift\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">func</span> <span class=\"title\">scheduledTimer</span>(<span class=\"title\">withTimeInterval</span> <span class=\"title\">interval</span>: <span class=\"title\">TimeInterval</span>, <span class=\"title\">repeats</span>: <span class=\"title\">Bool</span>, <span class=\"title\">block</span>: @<span class=\"title\">escaping</span> (<span class=\"title\">Timer</span>) -&gt; <span class=\"title\">Void</span>) -&gt; <span class=\"title\">Timer</span></span></span><br><span class=\"line\"><span class=\"class\"></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"title\">init</span>(<span class=\"title\">timeInterval</span> <span class=\"title\">interval</span>: <span class=\"title\">TimeInterval</span>, <span class=\"title\">repeats</span>: <span class=\"title\">Bool</span>, <span class=\"title\">block</span>: @<span class=\"title\">escaping</span> (<span class=\"title\">Timer</span>) -&gt; <span class=\"title\">Void</span>)</span></span><br><span class=\"line\"><span class=\"class\"></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"title\">convenience</span> <span class=\"title\">init</span>(<span class=\"title\">fire</span> <span class=\"title\">date</span>: <span class=\"title\">Date</span>, <span class=\"title\">interval</span>: <span class=\"title\">TimeInterval</span>, <span class=\"title\">repeats</span>: <span class=\"title\">Bool</span>, <span class=\"title\">block</span>: @<span class=\"title\">escaping</span> (<span class=\"title\">Timer</span>) -&gt; <span class=\"title\">Void</span>)</span></span><br></pre></td></tr></table></div></figure>\n\n\n\n<blockquote>\n<p>the timer itself is passed as the parameter to this block when executed to aid in avoiding cyclical references。</p>\n<p>翻译：在执行时，定时器本身作为参数传递给这个块，以帮助避免循环引用。</p>\n</blockquote>\n\n        <h3 id=\"引用\"   >\n          <a href=\"#引用\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#引用\" class=\"headerlink\" title=\"引用\"></a>引用</h3>\n      <p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://juejin.cn/post/6844903968250789896#heading-5\" >iOS之NSTimer循环引用的解决方案</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.jianshu.com/p/e8fc6c2b3afa\" >iOS中Timer循环引用原因及解决方案</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://developer.apple.com/documentation/foundation/nstimer/\" >Apple文档 - NSTimer</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n","site":{"data":{}},"excerpt":"","more":"\n        <h3 id=\"前言\"   >\n          <a href=\"#前言\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3>\n      <p>本文将从如何使用 <strong>NSTimer</strong> 、 <strong>NSTimer</strong> 何种情况下会造成循环引用，以及如何避免循环引用几个角度进行介绍。</p>\n\n        <h3 id=\"NSTimer-如何使用\"   >\n          <a href=\"#NSTimer-如何使用\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#NSTimer-如何使用\" class=\"headerlink\" title=\"NSTimer 如何使用\"></a>NSTimer 如何使用</h3>\n      <blockquote>\n<p>A timer that fires after a certain time interval has elapsed, sending a specified message to a target object.</p>\n<p>翻译：一种计时器，在经过一定的时间间隔后触发，向目标对象发送指定的消息。</p>\n</blockquote>\n\n        <h4 id=\"创建\"   >\n          <a href=\"#创建\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#创建\" class=\"headerlink\" title=\"创建\"></a>创建</h4>\n      <p><strong>NSTimer</strong> 提供了三种创建方式：</p>\n<ol>\n<li><p>以 <code>scheduledTimerWithTimeInterval</code> 类方法开头的创建实例</p>\n</li>\n<li><p>以 <code>timerWithTimeInterval</code> 开头的创建实例</p>\n</li>\n<li><p>以 <code>init</code> 方法初始化方法创建实例</p>\n</li>\n</ol>\n<p>若采用第一种方式创建，会以 <strong>default mode</strong> 方式自动加入到当前的 <strong>RunLoop</strong> 中。</p>\n<p>若采用第二、三种方式创建，需手动调用NSRunLoop对象的 <code>addTimer:forMode:</code> 方法。</p>\n<figure class=\"highlight swift\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> timer <span class=\"operator\">=</span> <span class=\"type\">Timer</span>.<span class=\"keyword\">init</span>(timeInterval: <span class=\"number\">1.0</span>, repeats: <span class=\"literal\">true</span>) &#123; timer <span class=\"keyword\">in</span></span><br><span class=\"line\">   <span class=\"built_in\">print</span>(<span class=\"string\">&quot;This&quot;</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">RunLoop</span>.main.add(timer, forMode: .default)</span><br></pre></td></tr></table></div></figure>\n\n\n        <h4 id=\"销毁\"   >\n          <a href=\"#销毁\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#销毁\" class=\"headerlink\" title=\"销毁\"></a>销毁</h4>\n      <p><code>invalidate()</code> </p>\n<p>该方法是在其加入的 <strong>RunLoop</strong> 对象中移除timer的唯一方法，同时会 <strong>RunLoop</strong> 对象会移除其对对象的强引用，若配置了 <strong>target</strong> 和 <strong>user info</strong> 对象， <strong>timer</strong> 也会移除对这些对象的强引用。</p>\n\n        <h3 id=\"为何会造成循环引用\"   >\n          <a href=\"#为何会造成循环引用\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#为何会造成循环引用\" class=\"headerlink\" title=\"为何会造成循环引用\"></a>为何会造成循环引用</h3>\n      \n        <h4 id=\"循环引用\"   >\n          <a href=\"#循环引用\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#循环引用\" class=\"headerlink\" title=\"循环引用\"></a>循环引用</h4>\n      <p>考虑一个常见使用 <strong>NSTimer</strong> 的场景：在 <strong>ViewController</strong> 中将 <strong>timer</strong> 作为属性，而 <strong>timer</strong> 在创建采用了 <strong>target-action</strong> 的方式，根据 <strong>Apple</strong> 文档，<strong>timer</strong> 会对 <strong>target</strong> 产生强引用，这就产生了有向环，导致循环引用，下图是上例对象引用图：</p>\n<img src=\"/assets/2021-09-29-NSTimer 循环引用分析与解决/image-20210817112104936.png\" alt=\"image-20210817112104936\" style=\"zoom:40%;\" />\n\n\n        <h4 id=\"RunLoop持有timer\"   >\n          <a href=\"#RunLoop持有timer\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#RunLoop持有timer\" class=\"headerlink\" title=\"RunLoop持有timer\"></a>RunLoop持有timer</h4>\n      <p>还是上例的场景，若在 <strong>timer</strong> 创建时不采用 <strong>target-action</strong> ，是不是就可以解决了？</p>\n<p>确实可以解决，但还存在一个问题，由于 <strong>RunLoop</strong> 对象还持有着 <strong>timer</strong> 对象，这时 <strong>ViewController</strong> 能被正常释放，但 <strong>timer</strong> 的引用计数由于不为 <strong>1</strong> ，无法被释放，这种情况只是 <strong>timer</strong> 无法被释放，并不算循环引用范畴，当然若 <strong>RunLoop</strong> 对象被释放了，则这个 <strong>timer</strong> 也会被释放掉。</p>\n<img src=\"/assets/2021-09-29-NSTimer 循环引用分析与解决/image-20210817145841853.png\" alt=\"image-20210817145841853\" style=\"zoom:40%;\" />\n\n<p>当然此上两种情况都是将 <strong>timer</strong> 的 <code>repeat</code> 参数设置为 <code>true</code> 时，若为 <code>false</code> 则在定时器第一次触发后，会自动失效，即 <strong>RunLoop</strong> 会移除对 <strong>timer</strong> 的强引用， <strong>timer</strong> 也会移除对 <strong>target</strong> 和 <strong>user info</strong> 对象的强引用。</p>\n\n        <h3 id=\"解决方案\"   >\n          <a href=\"#解决方案\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h3>\n      \n        <h4 id=\"合适的时机调用-invalidate\"   >\n          <a href=\"#合适的时机调用-invalidate\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#合适的时机调用-invalidate\" class=\"headerlink\" title=\"合适的时机调用 invalidate()\"></a>合适的时机调用 <code>invalidate()</code></h4>\n      <p>在上文介绍了<code>invalidate()</code> ， 我们只需要在合适的时机调用 <code>invalidate()</code>即可。</p>\n<p>那么什么是合适的时机呢？</p>\n<ol>\n<li>若清楚知道什么时候 <strong>timer</strong> 不再使用，则应立即调用。</li>\n<li>若不清楚则应破除循环引用，最后在 <strong>ViewController</strong> 的 <code>deinit</code> 中进行调用。</li>\n</ol>\n\n        <h4 id=\"针对循环引用，需破除有向环\"   >\n          <a href=\"#针对循环引用，需破除有向环\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#针对循环引用，需破除有向环\" class=\"headerlink\" title=\"针对循环引用，需破除有向环\"></a>针对循环引用，需破除有向环</h4>\n      <ol>\n<li>采用 <code>weak</code> 关键字修饰 <strong>timer</strong> ，但需采用<code>scheduledTimerWithTimeInterval</code> 类方法开头的创建实例，因为这个方法会将 <strong>timer</strong> 加入到 <strong>RunLoop</strong> 对象中，否则由于 <code>weak</code> 修饰， <strong>timer</strong> 会被自动设为<code>nil</code>。</li>\n<li>采用 <code>weak</code> 关键字修饰 <strong>target</strong> 对象，但需在 <strong>block</strong> 中进行使用，原理大概是 <strong>block</strong> 中的 <strong>weakSelf</strong> 相当于一个临时变量，进而阻止了循环引用。</li>\n<li>采用中介者模式，让其他对象承担 <code>target</code> 角色，从而阻止循环引用。</li>\n<li>基于 <strong>NSProxy</strong> 方式，与 <strong>3</strong> 类似，通过其他对象来阻止循环引用，需注意的是 <strong>NSProxy</strong> 无法直接使用。</li>\n<li>也可直接使用 <strong>Apple</strong> 提供的新 <strong>API</strong>：</li>\n</ol>\n<figure class=\"highlight swift\"><div class=\"table-container\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">func</span> <span class=\"title\">scheduledTimer</span>(<span class=\"title\">withTimeInterval</span> <span class=\"title\">interval</span>: <span class=\"title\">TimeInterval</span>, <span class=\"title\">repeats</span>: <span class=\"title\">Bool</span>, <span class=\"title\">block</span>: @<span class=\"title\">escaping</span> (<span class=\"title\">Timer</span>) -&gt; <span class=\"title\">Void</span>) -&gt; <span class=\"title\">Timer</span></span></span><br><span class=\"line\"><span class=\"class\"></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"title\">init</span>(<span class=\"title\">timeInterval</span> <span class=\"title\">interval</span>: <span class=\"title\">TimeInterval</span>, <span class=\"title\">repeats</span>: <span class=\"title\">Bool</span>, <span class=\"title\">block</span>: @<span class=\"title\">escaping</span> (<span class=\"title\">Timer</span>) -&gt; <span class=\"title\">Void</span>)</span></span><br><span class=\"line\"><span class=\"class\"></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"title\">convenience</span> <span class=\"title\">init</span>(<span class=\"title\">fire</span> <span class=\"title\">date</span>: <span class=\"title\">Date</span>, <span class=\"title\">interval</span>: <span class=\"title\">TimeInterval</span>, <span class=\"title\">repeats</span>: <span class=\"title\">Bool</span>, <span class=\"title\">block</span>: @<span class=\"title\">escaping</span> (<span class=\"title\">Timer</span>) -&gt; <span class=\"title\">Void</span>)</span></span><br></pre></td></tr></table></div></figure>\n\n\n\n<blockquote>\n<p>the timer itself is passed as the parameter to this block when executed to aid in avoiding cyclical references。</p>\n<p>翻译：在执行时，定时器本身作为参数传递给这个块，以帮助避免循环引用。</p>\n</blockquote>\n\n        <h3 id=\"引用\"   >\n          <a href=\"#引用\" class=\"heading-link\"><i class=\"fas fa-link\"></i></a><a href=\"#引用\" class=\"headerlink\" title=\"引用\"></a>引用</h3>\n      <p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://juejin.cn/post/6844903968250789896#heading-5\" >iOS之NSTimer循环引用的解决方案</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://www.jianshu.com/p/e8fc6c2b3afa\" >iOS中Timer循环引用原因及解决方案</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n<p><span class=\"exturl\"><a class=\"exturl__link\"   href=\"https://developer.apple.com/documentation/foundation/nstimer/\" >Apple文档 - NSTimer</a><span class=\"exturl__icon\"><i class=\"fas fa-external-link-alt\"></i></span></span></p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"ckvko2j290001qezucdkignnj","category_id":"ckvko2j2d0003qezueplv40vs","_id":"ckvko2j2f0006qezuf8ax5p72"},{"post_id":"ckvko2j2n0009qezuccskefx3","category_id":"ckvko2j2d0003qezueplv40vs","_id":"ckvko2j2o000bqezucpveasra"}],"PostTag":[{"post_id":"ckvko2j290001qezucdkignnj","tag_id":"ckvko2j2e0004qezugevkhrs2","_id":"ckvko2j2g0007qezu8lqlcslt"},{"post_id":"ckvko2j290001qezucdkignnj","tag_id":"ckvko2j2f0005qezufovc71fo","_id":"ckvko2j2g0008qezu8w9ddctk"},{"post_id":"ckvko2j2n0009qezuccskefx3","tag_id":"ckvko2j2o000aqezuhuao3fzk","_id":"ckvko2j2o000cqezu61d3hp9n"},{"post_id":"ckvko2j2n0009qezuccskefx3","tag_id":"ckvko2j2e0004qezugevkhrs2","_id":"ckvko2j2o000dqezud9or894q"}],"Tag":[{"name":"iOS","_id":"ckvko2j2e0004qezugevkhrs2"},{"name":"Compile","_id":"ckvko2j2f0005qezufovc71fo"},{"name":"NSTimer","_id":"ckvko2j2o000aqezuhuao3fzk"}]}}